<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cổng Tác Vụ NCTN 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#C41E3A',
            'sidebar': '#0f172a',
            'sidebar-hover': '#1e293b',
            'muted': '#f8fafc'
          }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * { scroll-behavior: smooth; }
    .spinner{border:2px solid #e5e7eb;border-top:2px solid #C41E3A;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .header-container{background:linear-gradient(135deg,#C41E3A 0%,#EF4444 100%);position:relative;overflow:hidden;box-shadow:0 10px 25px rgba(196,30,58,0.2)}
    .header-container::before{content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");opacity:.4}
    .modal{position:fixed;inset:0;background:rgba(15,23,42,0.5);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000;transition:opacity 0.3s ease}
    .section-title{display:flex;align-items:center;gap:8px}
    .section-title .badge{background:rgba(196,30,58,.15);color:#7f1d1d;border:1px solid rgba(196,30,58,.35);padding:2px 8px;border-radius:9999px;font-size:12px;font-weight:600}
    .submit-btn{background:linear-gradient(135deg,#C41E3A 0%,#EF4444 100%);box-shadow:0 4px 6px rgba(196,30,58,.15),0 1px 3px rgba(196,30,58,.1);transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);border-radius:9999px;position:relative}
    .submit-btn:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(196,30,58,.2),0 4px 8px rgba(196,30,58,.15);filter:brightness(1.05)}
    .submit-btn:active{transform:translateY(0);opacity:.95}
    .modal.open{display:flex;animation:fadeIn 0.3s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#fff;padding:12px 16px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);opacity:0;transform:translateY(10px);transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);z-index:9999;min-width:200px}
    .toast.show{opacity:1;transform:translateY(0)}
    /* Sidebar improvements */
    .nav-btn{position:relative;transition:all 0.2s ease}
    .nav-btn:hover{background:rgba(196,30,58,0.15)!important;transform:translateX(2px)}
    .nav-btn.bg-primary-blue{background:rgba(196,30,58,0.25)!important;font-weight:600}
    .nav-btn.bg-primary-blue .w-8{background:rgba(196,30,58,0.4)!important}
    .nav-btn.bg-primary-blue .w-8 .material-icons{color:#fff!important}
    .nav-btn.bg-primary-blue span:last-child{color:#fff!important;font-weight:600}
    .nav-btn.bg-primary-blue::before{content:"";position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:60%;background:#C41E3A;border-radius:0 4px 4px 0;opacity:1}
    /* Form sections */
    section{transition:all 0.3s ease;border:1px solid rgba(229,231,235,0.8)}
    section:hover{box-shadow:0 4px 12px rgba(0,0,0,0.08)}
    /* Table improvements */
    .table-zebra tbody tr:nth-child(even){background-color:#f8fafc}
    .table-zebra tbody tr:hover{background-color:#fef2f2!important;transition:background-color 0.15s ease}
    .cell-div{border-left:1px solid #e5e7eb}
    .table-vdiv{border-collapse:separate;border-spacing:0}
    .table-vdiv th+th,.table-vdiv td+td{border-left:1px solid #e5e7eb}
    /* Input improvements */
    input[type="text"],input[type="email"],input[type="number"],select,textarea{transition:all 0.2s ease}
    input[type="text"]:focus,input[type="email"]:focus,input[type="number"]:focus,select:focus,textarea:focus{box-shadow:0 0 0 3px rgba(196,30,58,0.1)}
    /* Button improvements */
    button{transition:all 0.2s ease;cursor:pointer}
    button:disabled{opacity:0.6;cursor:not-allowed}
    /* Form 2: Tab styling */
    .f2-panel{transition:all 0.3s ease}
    .f2-panel.hidden{display:none}
    /* Scrollbar styling */
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-track{background:#f1f5f9;border-radius:4px}
    ::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}
    ::-webkit-scrollbar-thumb:hover{background:#94a3b8}
    /* Card hover effects */
    .card-hover{transition:all 0.3s ease}
    .card-hover:hover{transform:translateY(-2px);box-shadow:0 8px 16px rgba(0,0,0,0.1)}
    /* Loading states */
    .loading-shimmer{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
  </style>
</head>
<body class="bg-muted min-h-screen flex text-gray-800" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'">
  <!-- Sidebar -->
  <aside class="w-72 min-h-screen bg-sidebar text-white flex flex-col shadow-2xl border-r border-red-900/30">
    <!-- Sidebar Header -->
    <div class="px-6 py-6 border-b border-red-200/20">
      <div class="flex items-center gap-3">
        <div class="p-2.5 bg-gradient-to-br from-primary-blue to-red-600 rounded-xl shadow-lg">
          <span class="material-icons text-white text-2xl">dashboard</span>
        </div>
        <div>
          <h1 class="text-lg font-bold tracking-tight text-white">Cổng Tác Vụ</h1>
          <p class="text-xs text-red-200/80 font-medium">NCTN 2</p>
        </div>
      </div>
    </div>
    
    <!-- Navigation -->
    <nav class="flex flex-col gap-1.5 flex-1 px-3 py-4 overflow-y-auto">
      <button class="nav-btn group relative py-3.5 px-4 rounded-xl text-left text-sm font-medium flex items-center gap-3 transition-all duration-200" data-target="form1">
        <div class="flex items-center gap-3 flex-1">
          <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-900/30 group-hover:bg-red-900/50 transition-colors">
            <span class="material-icons text-lg text-red-200 group-hover:text-white transition-colors" style="font-size: 20px; line-height: 1; display: inline-flex; align-items: center; justify-content: center;">search</span>
          </div>
          <span class="text-gray-200 group-hover:text-white transition-colors">Form 1 · Tra cứu tác vụ</span>
        </div>
        <div class="absolute left-0 top-1/2 -translate-y-1/2 w-1 h-0 bg-primary-blue rounded-r-full transition-all duration-200 opacity-0 group-hover:opacity-100 group-hover:h-6"></div>
      </button>
      
      <button class="nav-btn group relative py-3.5 px-4 rounded-xl text-left text-sm font-medium flex items-center gap-3 transition-all duration-200" data-target="form2">
        <div class="flex items-center gap-3 flex-1">
          <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-900/30 group-hover:bg-red-900/50 transition-colors">
            <span class="material-icons text-lg text-red-200 group-hover:text-white transition-colors" style="font-size: 20px; line-height: 1; display: inline-flex; align-items: center; justify-content: center;">list_alt</span>
          </div>
          <span class="text-gray-200 group-hover:text-white transition-colors">Form 2 · Tất cả tác vụ</span>
        </div>
        <div class="absolute left-0 top-1/2 -translate-y-1/2 w-1 h-0 bg-primary-blue rounded-r-full transition-all duration-200 opacity-0 group-hover:opacity-100 group-hover:h-6"></div>
      </button>
      
      <button class="nav-btn group relative py-3.5 px-4 rounded-xl text-left text-sm font-medium flex items-center gap-3 transition-all duration-200" data-target="form3">
        <div class="flex items-center gap-3 flex-1">
          <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-900/30 group-hover:bg-red-900/50 transition-colors">
            <span class="material-icons text-lg text-red-200 group-hover:text-white transition-colors" style="font-size: 20px; line-height: 1; display: inline-flex; align-items: center; justify-content: center;">account_tree</span>
          </div>
          <span class="text-gray-200 group-hover:text-white transition-colors">Form 3 · Quản lý dự án</span>
        </div>
        <div class="absolute left-0 top-1/2 -translate-y-1/2 w-1 h-0 bg-primary-blue rounded-r-full transition-all duration-200 opacity-0 group-hover:opacity-100 group-hover:h-6"></div>
      </button>
      
      <button class="nav-btn group relative py-3.5 px-4 rounded-xl text-left text-sm font-medium flex items-center gap-3 transition-all duration-200" data-target="form6">
        <div class="flex items-center gap-3 flex-1">
          <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-900/30 group-hover:bg-red-900/50 transition-colors">
            <span class="material-icons text-lg text-red-200 group-hover:text-white transition-colors" style="font-size: 20px; line-height: 1; display: inline-flex; align-items: center; justify-content: center;">analytics</span>
          </div>
          <span class="text-gray-200 group-hover:text-white transition-colors">Form 6 · Dashboard Thống kê</span>
        </div>
        <div class="absolute left-0 top-1/2 -translate-y-1/2 w-1 h-0 bg-primary-blue rounded-r-full transition-all duration-200 opacity-0 group-hover:opacity-100 group-hover:h-6"></div>
      </button>
      
      <button class="nav-btn group relative py-3.5 px-4 rounded-xl text-left text-sm font-medium flex items-center gap-3 transition-all duration-200" data-target="form7">
        <div class="flex items-center gap-3 flex-1">
          <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-red-900/30 group-hover:bg-red-900/50 transition-colors">
            <span class="material-icons text-lg text-red-200 group-hover:text-white transition-colors" style="font-size: 20px; line-height: 1; display: inline-flex; align-items: center; justify-content: center;">table_chart</span>
          </div>
          <span class="text-gray-200 group-hover:text-white transition-colors">Form 7 · Dashboard Excel</span>
        </div>
        <div class="absolute left-0 top-1/2 -translate-y-1/2 w-1 h-0 bg-primary-blue rounded-r-full transition-all duration-200 opacity-0 group-hover:opacity-100 group-hover:h-6"></div>
      </button>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 py-8 px-4 flex flex-col items-center min-h-screen overflow-y-auto bg-gradient-to-br from-gray-50 to-gray-100">
    <div class="header-container relative w-full max-w-6xl rounded-2xl overflow-hidden mb-8 shadow-xl">
      <div class="relative z-10 p-8 md:p-12">
        <div class="flex items-center space-x-2 mb-4">
          <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full text-xs font-semibold text-white backdrop-blur-md" style="background-color: rgba(255,255,255,0.2); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <span class="material-icons text-sm">business</span>
            <span>Phòng NCTN 2</span>
          </div>
        </div>
        <h2 class="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-2 tracking-tight leading-tight">Cổng tác vụ NCTN 2 - Nội bộ</h2>
        <p class="text-red-50 text-sm md:text-base font-medium">Vui lòng không chia sẻ link cổng tác vụ với người ngoài bộ phận.</p>
      </div>
    </div>

    <!-- Form 1 -->
    <section id="form1" class="w-full max-w-none bg-white p-8 rounded-xl shadow-lg border border-gray-100 mb-6">
      <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-red-50 rounded-lg">
            <span class="material-icons text-primary-blue">search</span>
          </div>
          <h2 class="text-2xl font-bold text-gray-900">Form 1 · Tra cứu tác vụ</h2>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Chọn tên</label>
          <div class="flex gap-2">
            <select id="f1-name" class="flex-1 border border-red-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white">
              <option value="">— Chọn người —</option>
            </select>
            <button id="f1-search" class="px-5 py-2.5 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105 shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2">
              <span class="material-icons text-sm">search</span>
              <span>Tra cứu</span>
            </button>
            <button id="f1-unassigned" class="px-4 py-2.5 rounded-lg border-2 border-gray-300 text-gray-700 bg-white hover:bg-gray-50 hover:border-gray-400 transition-all duration-200">Chưa phân công</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Chọn tên và nhấn Tra cứu để gửi yêu cầu và hiển thị tác vụ</p>
        </div>
        <div class="md:col-span-2">
          <div class="flex items-center gap-3">
            <label class="text-sm font-medium text-gray-700 whitespace-nowrap">Lọc theo tháng:</label>
            <select id="f1-month" class="w-40 border border-red-300 rounded-lg bg-slate-100 p-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white">
              <option value="">— Tất cả tháng —</option>
            </select>
            <button id="f1-clear-filter" class="px-3 py-1.5 text-sm rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Xóa lọc</button>
          </div>
          <p class="text-gray-500 text-xs mt-1">Các tác vụ Doing sẽ luôn hiện lên đầu và không bị lọc theo tháng</p>
        </div>
      </div>
      <div class="mt-6 overflow-auto max-h-[60vh] border-2 border-gray-200 rounded-xl shadow-inner">
        <table class="min-w-[1760px] w-full text-sm">
          <thead class="bg-gradient-to-r from-red-100 via-red-50 to-red-100 sticky top-0 z-10 shadow-sm">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 min-w-[160px]">Trả báo cáo</th>
              <th class="px-3 py-2 min-w-[140px]">Tình trạng</th>
              <th class="px-3 py-2 min-w-[160px]">Ngày hoàn thành thực tế</th>
              <th class="px-3 py-2 min-w-[140px]">Mã</th>
              <th class="px-3 py-2 min-w-[260px]">Tên tác vụ</th>
              <th class="px-3 py-2 min-w-[160px]">Người yêu cầu</th>
              <th class="px-3 py-2 min-w-[120px]">Công chuẩn</th>
              <th class="px-3 py-2 min-w-[140px]">Ngày yêu cầu</th>
              <th class="px-3 py-2 min-w-[140px]">Hạn mong muốn</th>
              <th class="px-3 py-2 min-w-[140px]">Hạn đáp ứng</th>
              <th class="px-3 py-2 min-w-[260px]">Mục đích đánh giá</th>
              <th class="px-3 py-2 min-w-[240px]">Note</th>
              <th class="px-3 py-2 min-w-[240px]">Yêu cầu test đặc biệt</th>
              <th class="px-3 py-2 min-w-[260px]">Form báo cáo đánh giá</th>
              <th class="px-3 py-2 min-w-[220px]">Tên file đính kèm</th>
            </tr>
          </thead>
          <tbody id="f1-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="15">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
      </div>
      <div id="f1-pager" class="mt-2 flex items-center justify-between" style="display:none">
        <div class="text-sm text-gray-600">
          <span id="f1-page-info">Trang 1/1 (0 dòng)</span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Hiển thị</label>
          <select id="f1-size" class="border border-red-300 rounded-lg bg-slate-100 p-1 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white">
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
          <button id="f1-prev" class="px-4 py-2 rounded-lg border-2 border-gray-300 text-gray-700 bg-white hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 flex items-center gap-1">
            <span class="material-icons text-sm">chevron_left</span>
            <span>Trước</span>
          </button>
          <button id="f1-next" class="px-4 py-2 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105 shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-1">
            <span>Sau</span>
            <span class="material-icons text-sm">chevron_right</span>
          </button>
        </div>
      </div>

      <!-- Điểm lưu trữ file đính kèm -->
      <div class="mt-6 p-4 bg-gradient-to-r from-red-50 to-red-100 rounded-xl border border-red-200">
        <a id="f1-storage-link" href="https://drive.google.com/drive/u/0/folders/1iVSNn6Ddv6jEun6lyMvOMcan2fpnFSpU" target="_blank" rel="noopener" title="Nhấn để mở và tự động copy liên kết"
           class="inline-flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 border-red-300 bg-white text-primary-blue hover:bg-red-50 hover:border-primary-blue transition-all duration-200 shadow-sm hover:shadow-md font-medium">
          <span class="material-icons text-lg">folder_shared</span>
          <span>Điểm lưu trữ file đính kèm</span>
        </a>
        <p class="text-xs text-gray-600 mt-2 ml-1">Nhấn để mở và copy liên kết.</p>
      </div>
    </section>

    <!-- Form 2 · Tất cả tác vụ -->
    <section id="form2" class="w-full max-w-none bg-white p-8 rounded-xl shadow-lg border border-gray-100 mb-6 hidden">
      <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-red-50 rounded-lg">
            <span class="material-icons text-primary-blue">list_alt</span>
          </div>
          <h2 class="text-2xl font-bold text-gray-900">Form 2 · Tất cả tác vụ</h2>
        </div>
        <div class="flex items-center gap-2">
          <button id="f2-export" class="px-4 py-2 rounded-lg border-2 border-red-300 text-primary-blue bg-red-50 hover:bg-red-100 hover:border-primary-blue transition-all duration-200 flex items-center gap-2 shadow-sm hover:shadow-md">
            <span class="material-icons text-sm">cloud_upload</span>
            <span>Xuất server</span>
          </button>
          <button id="f2-export-xlsx" class="px-4 py-2 rounded-lg border-2 border-red-300 text-primary-blue bg-red-50 hover:bg-red-100 hover:border-primary-blue transition-all duration-200 flex items-center gap-2 shadow-sm hover:shadow-md">
            <span class="material-icons text-sm">download</span>
            <span>Xuất XLSX</span>
          </button>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex items-center gap-2 p-2">
          <label class="text-sm text-gray-700">Tháng</label>
          <input id="f2-month" type="month" class="border border-red-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white"/>
        </div>
        <!-- P1 Header -->
        <div class="mt-2 flex items-center gap-2 border-b border-gray-200">
          <div class="px-4 py-2 font-semibold text-red-800 bg-red-50 rounded-t-lg border-b-2 border-red-200">Thống kê tiến độ</div>
        </div>
        <!-- Thẻ P1: Thống kê tiến độ -->
        <div id="f2-panel-p1" class="f2-panel bg-white border border-gray-200 rounded-lg shadow-sm mt-2">
          <div class="px-3 py-2 border-b border-gray-200 bg-gradient-to-r from-red-50 to-white flex items-center justify-center">
            <span class="font-semibold text-red-800 mr-4">Thẻ - Thống kê tiến độ</span>
            <button id="f2-search-p1" class="submit-btn px-3 py-1.5 text-white text-sm font-semibold transition">Tra cứu</button>
          </div>
          <div class="overflow-auto max-h-[60vh] p-2">
          <table class="min-w-[1200px] w-full text-sm table-zebra table-vdiv">
          <thead class="bg-gradient-to-r from-red-100 to-red-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2">Nhân viên</th>
              <th class="px-3 py-2">Tổng tác vụ đang thực hiện</th>
              <th class="px-3 py-2">Số Done trong tháng</th>
              <th class="px-3 py-2">Vượt tiến độ</th>
              <th class="px-3 py-2">Đúng tiến độ</th>
              <th class="px-3 py-2">Chậm tiến độ</th>
              <th class="px-3 py-2">Số N/A</th>
              <th class="px-3 py-2">Tỷ lệ vượt (%)</th>
              <th class="px-3 py-2">Tỷ lệ đúng (%)</th>
              <th class="px-3 py-2">Tỷ lệ chậm (%)</th>
              <th class="px-3 py-2">%N/A</th>
            </tr>
          </thead>
            <tbody id="f2-body-p1" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="11">Chưa có dữ liệu</td></tr>
          </tbody>
        </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Form 3 - Quản lý dự án -->
    <section id="form3" class="w-full bg-white/50 p-6 lg:p-10 rounded-lg shadow-md hidden flex flex-col" style="min-height: calc(100vh - 120px);">
      <div class="mx-auto flex w-full flex-col gap-6 flex-1">
        <!-- Page Heading -->
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-[#131118]">Quản lý dự án</h2>
            <p class="text-[#6b6189] text-sm mt-1">Theo dõi tiến độ và phân cấp công việc Epic → Story → Subtask</p>
          </div>
          <div class="flex flex-wrap gap-2">
            <button id="f3-load-data-btn" class="flex items-center gap-2 px-4 py-2.5 bg-white border border-[#e5e7eb] rounded-full text-sm font-medium hover:bg-gray-50 transition-colors shadow-sm">
              <span class="material-icons text-[18px]">refresh</span>
              <span>Tải dữ liệu</span>
            </button>
            <button id="f3-export-btn" class="flex items-center gap-2 px-4 py-2.5 bg-white border border-[#e5e7eb] rounded-full text-sm font-medium hover:bg-gray-50 transition-colors shadow-sm">
              <span class="material-icons text-[18px]">table_view</span>
              <span>Xuất Excel</span>
            </button>
          </div>
      </div>

        <!-- Upload Section -->
        <div class="rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 p-6 shadow-sm hidden">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-800">Upload File Excel</h3>
            <span class="text-xs text-gray-500">Hỗ trợ .xlsx, .xls</span>
          </div>
          
          <div id="f3-drop-zone" class="relative border-2 border-dashed border-blue-300 rounded-lg p-8 text-center bg-white hover:border-blue-500 transition-colors cursor-pointer">
            <input type="file" id="f3-excel-file" accept=".xlsx,.xls" class="hidden">
            <div id="f3-drop-content" class="flex flex-col items-center gap-3">
              <span class="material-icons text-5xl text-blue-500">cloud_upload</span>
              <div>
                <p class="text-sm font-medium text-gray-700">Kéo thả file Excel vào đây</p>
                <p class="text-xs text-gray-500 mt-1">hoặc click để chọn file</p>
            </div>
          </div>
            <div id="f3-file-info" class="hidden flex items-center justify-between gap-3 mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
              <div class="flex items-center gap-3 flex-1">
                <span class="material-icons text-green-600">description</span>
                <div class="flex-1 text-left">
                  <p id="f3-file-name" class="text-sm font-medium text-gray-900"></p>
                  <p id="f3-file-size" class="text-xs text-gray-500"></p>
        </div>
      </div>
              <button id="f3-file-remove" class="text-red-500 hover:text-red-700 transition">
                <span class="material-icons">close</span>
        </button>
            </div>
      </div>

          <div class="flex items-center justify-center gap-3 mt-4">
            <button id="f3-submit-btn" class="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
              <span class="material-icons">upload</span>
              <span>Tải lên server</span>
            </button>
            </div>
          </div>

        <!-- Search and Filter -->
        <div class="flex flex-col lg:flex-row gap-3 pt-2">
          <!-- Search Input -->
          <div class="relative w-full lg:max-w-md">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <span class="material-icons text-[#6b6189]">search</span>
            </div>
            <input id="f3-search-input" type="text" placeholder="Tìm theo tên, Jira Key, Assignee..." class="block w-full pl-10 pr-3 py-2.5 border-none rounded-full leading-5 bg-white text-[#131118] placeholder-[#9ca3af] focus:outline-none focus:bg-white focus:ring-2 focus:ring-primary/20 shadow-sm ring-1 ring-[#e5e7eb]">
          </div>
          <!-- Filters -->
          <div class="flex gap-2 overflow-x-auto pb-2 lg:pb-0 no-scrollbar">
            <select id="f3-filter-status" class="pl-3 pr-8 py-2.5 bg-white border-none ring-1 ring-[#e5e7eb] rounded-full text-sm font-medium text-[#131118] focus:ring-2 focus:ring-primary/20 shadow-sm cursor-pointer appearance-none">
              <option value="">Tất cả trạng thái</option>
              <option value="hoàn thành">Hoàn thành</option>
              <option value="đang triển khai">Đang triển khai</option>
              <option value="chưa triển khai">Chưa triển khai</option>
              <option value="hủy tác vụ">Hủy tác vụ</option>
              <option value="cancelled">Đã hủy</option>
            </select>
            <select id="f3-filter-assignee" class="pl-3 pr-8 py-2.5 bg-white border-none ring-1 ring-[#e5e7eb] rounded-full text-sm font-medium text-[#131118] focus:ring-2 focus:ring-primary/20 shadow-sm cursor-pointer appearance-none">
              <option value="">Tất cả thành viên</option>
              <!-- Options sẽ được populate bằng JavaScript -->
            </select>
            <select id="f3-filter-level" class="pl-3 pr-8 py-2.5 bg-white border-none ring-1 ring-[#e5e7eb] rounded-full text-sm font-medium text-[#131118] focus:ring-2 focus:ring-primary/20 shadow-sm cursor-pointer appearance-none">
              <option value="all">Tất cả cấp</option>
              <option value="story">Story và Subtask</option>
              <option value="subtask">Chỉ Subtask</option>
            </select>
          </div>
        </div>

        <!-- Hierarchical Data Table -->
        <div class="overflow-hidden rounded-lg bg-white shadow-sm border border-[#f1f0f4] flex-1 flex flex-col">
          <div class="overflow-x-auto overflow-y-auto flex-1" style="min-height: 0;">
            <!-- Table Header -->
            <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-[#fafafa] border-b border-[#f1f0f4] text-xs font-semibold text-[#6b6189] uppercase tracking-wider sticky top-0 z-10">
              <div class="col-span-3 flex items-center">Tên công việc</div>
              <div class="col-span-1 flex items-center">Thay đổi</div>
              <div class="col-span-2 flex items-center">Người thực hiện</div>
              <div class="col-span-1 flex items-center">Trạng thái</div>
              <div class="col-span-1 flex items-center">Ngày bắt đầu</div>
              <div class="col-span-1 flex items-center">Hạn HT</div>
              <div class="col-span-1 flex items-center">Ngày hoàn thành</div>
              <div class="col-span-1 flex items-center">Mã Jira/KOI</div>
              <div class="col-span-1 flex items-center">Ghi chú</div>
            </div>
            <!-- Table Body (Scrollable) -->
            <div class="custom-scrollbar-f3">
              <div id="f3-table-body" class="divide-y divide-[#f1f0f4]">
                <div class="px-6 py-8 text-center text-[#6b6189]">
                  <div class="flex flex-col items-center gap-2">
                    <span class="material-icons text-4xl text-gray-300">table_chart</span>
                    <p>Chưa có dữ liệu. Vui lòng tải dữ liệu hoặc upload file Excel.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading Indicator -->
        <div id="f3-loading" class="hidden flex items-center justify-center gap-2 text-primary py-4">
          <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Đang tải...</span>
        </div>
      </div>
    </section>
    
    <!-- Custom scrollbar styles for Form 3 only - scoped to prevent affecting other forms -->
    <style>
        /* Form 3 specific scrollbar - scoped to #form3 only */
        #form3 .custom-scrollbar-f3::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #form3 .custom-scrollbar-f3::-webkit-scrollbar-track {
            background: transparent;
        }
        #form3 .custom-scrollbar-f3::-webkit-scrollbar-thumb {
            background-color: #e5e7eb;
            border-radius: 9999px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        #form3 .custom-scrollbar-f3::-webkit-scrollbar-thumb:hover {
            background-color: #d1d5db;
        }
        /* Form 3 specific no-scrollbar - only applies within form3 */
        #form3 .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        #form3 .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>


    <!-- Form 6 - Dashboard Thống kê -->
    <section id="form6" class="w-full bg-white p-6 lg:p-10 rounded-lg shadow-md hidden">
      <div class="mx-auto flex w-full flex-col gap-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-3">
            <div class="p-3 bg-blue-50 rounded-xl shadow-sm">
              <span class="material-icons text-primary-blue text-2xl">dashboard</span>
            </div>
            <div>
              <h2 class="text-2xl font-bold text-gray-900">Dashboard Tổng quan</h2>
              <p class="text-sm text-gray-600">Thống kê và theo dõi tiến độ dự án, tác vụ</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="f6-load-btn" class="flex items-center gap-2 px-4 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-colors text-sm font-medium">
              <span class="material-icons text-lg">upload_file</span>
              <span>Tải dữ liệu</span>
            </button>
            <input type="file" id="f6-file-input" accept=".txt,.json" style="display: none;">
            <button id="f6-refresh-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors text-sm font-medium">
              <span class="material-icons text-lg">refresh</span>
              <span>Tải lại</span>
            </button>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-600 text-sm font-medium mb-1">Tổng Dự án</p>
                <p class="text-gray-900 text-3xl font-bold" id="f6-stat-projects">0</p>
              </div>
              <div class="p-3 bg-blue-200 rounded-lg">
                <span class="material-icons text-blue-700 text-2xl">folder</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-purple-600 text-sm font-medium mb-1">Tổng Tác vụ</p>
                <p class="text-gray-900 text-3xl font-bold" id="f6-stat-tasks">0</p>
              </div>
              <div class="p-3 bg-purple-200 rounded-lg">
                <span class="material-icons text-purple-700 text-2xl">assignment</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-green-50 to-green-100 border border-green-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-green-600 text-sm font-medium mb-1">Tổng Subtask</p>
                <p class="text-gray-900 text-3xl font-bold" id="f6-stat-subtasks">0</p>
              </div>
              <div class="p-3 bg-green-200 rounded-lg">
                <span class="material-icons text-green-700 text-2xl">checklist</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-orange-600 text-sm font-medium mb-1">Tỷ lệ Hoàn thành</p>
                <p class="text-gray-900 text-3xl font-bold" id="f6-stat-completion">0%</p>
              </div>
              <div class="p-3 bg-orange-200 rounded-lg">
                <span class="material-icons text-orange-700 text-2xl">trending_up</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- Trạng thái Subtask -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Trạng thái Subtask</h3>
            <div id="f6-chart-subtask-status" class="flex items-center justify-center min-h-[200px]">
              <!-- Chart sẽ được render bằng JavaScript -->
            </div>
          </div>
          <!-- Phân bổ theo PIC -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Phân bổ theo Người thực hiện</h3>
            <div id="f6-chart-pic-distribution" class="min-h-[200px]">
              <!-- Chart sẽ được render bằng JavaScript -->
            </div>
          </div>
        </div>

        <!-- Tasks sắp hết hạn -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-6 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">Tác vụ sắp hết hạn (7 ngày tới)</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Tên tác vụ</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Dự án</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Người thực hiện</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Hạn chót</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Còn lại</th>
                </tr>
              </thead>
              <tbody id="f6-due-tasks-body" class="divide-y divide-gray-200">
                <!-- Dữ liệu sẽ được render bằng JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Bảng chi tiết Dự án -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-6 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-900">Chi tiết Dự án</h3>
            <div class="flex items-center gap-2">
              <div class="relative">
                <span class="material-icons pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm">search</span>
                <input id="f6-search-input" class="h-9 w-64 rounded-lg border-gray-300 bg-gray-50 pl-9 pr-4 text-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Tìm kiếm..." type="text"/>
              </div>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Mã dự án</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Tên dự án</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Số tác vụ</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Số subtask</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Tiến độ</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Người phụ trách</th>
                </tr>
              </thead>
              <tbody id="f6-projects-table-body" class="divide-y divide-gray-200">
                <!-- Dữ liệu sẽ được render bằng JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Form 7 - Dashboard Dữ liệu Excel -->
    <section id="form7" class="w-full bg-white p-6 lg:p-10 rounded-lg shadow-md hidden">
      <div class="mx-auto flex w-full flex-col gap-6">
        <!-- Page Heading -->
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <div class="p-3 bg-blue-50 rounded-xl shadow-sm">
              <span class="material-icons text-primary-blue text-2xl">table_chart</span>
            </div>
            <div class="flex flex-col gap-1">
              <h2 class="text-2xl font-bold text-gray-900">Dashboard Dữ liệu Excel</h2>
              <p class="text-gray-600 text-sm">Thống kê và phân tích dữ liệu từ Excel</p>
            </div>
          </div>
          <button id="f7-refresh-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors text-sm font-medium">
            <span class="material-icons text-lg">refresh</span>
            <span>Tải lại</span>
          </button>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-600 text-sm font-medium mb-1">Tổng Epic</p>
                <p class="text-gray-900 text-3xl font-bold" id="f7-stat-epics">0</p>
              </div>
              <div class="p-3 bg-blue-200 rounded-lg">
                <span class="material-icons text-blue-700 text-2xl">folder</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-purple-600 text-sm font-medium mb-1">Tổng Story</p>
                <p class="text-gray-900 text-3xl font-bold" id="f7-stat-stories">0</p>
              </div>
              <div class="p-3 bg-purple-200 rounded-lg">
                <span class="material-icons text-purple-700 text-2xl">description</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-green-50 to-green-100 border border-green-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-green-600 text-sm font-medium mb-1">Tổng Subtask</p>
                <p class="text-gray-900 text-3xl font-bold" id="f7-stat-subtasks">0</p>
              </div>
              <div class="p-3 bg-green-200 rounded-lg">
                <span class="material-icons text-green-700 text-2xl">task</span>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-3 rounded-xl p-5 bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-orange-600 text-sm font-medium mb-1">Tỷ lệ Hoàn thành</p>
                <p class="text-gray-900 text-3xl font-bold" id="f7-stat-completion">0%</p>
              </div>
              <div class="p-3 bg-orange-200 rounded-lg">
                <span class="material-icons text-orange-700 text-2xl">trending_up</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ASSIGNEE FOCUS SECTION -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border-2 border-blue-200">
          <div class="flex items-center gap-3">
            <span class="material-icons text-3xl text-blue-600">people</span>
            <h2 class="text-2xl font-bold text-gray-900">Dashboard Phân tích theo Người thực hiện</h2>
          </div>
        </div>

        <!-- Main Content Row: Assignee Progress + Status Table -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-start">
          <!-- Assignee Progress Overview - Biểu đồ cột (2/3 width) -->
          <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4">
              <span class="material-icons text-blue-600 text-xl">trending_up</span>
              <h3 class="text-lg font-semibold text-gray-900">Tiến độ hoàn thành theo Người thực hiện</h3>
            </div>
            <div id="f7-assignee-progress" class="w-full">
              <p class="text-gray-500 text-center py-8">Chưa có dữ liệu</p>
            </div>
          </div>

          <!-- Status Breakdown Table - Gọn lại (1/3 width) -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col h-full">
            <div class="p-3 border-b border-gray-200 flex-shrink-0">
              <h3 class="text-sm font-semibold text-gray-900">Chi tiết theo Trạng thái</h3>
            </div>
            <div class="overflow-x-auto overflow-y-auto flex-1" style="max-height: calc(200px + 3rem);">
              <table class="w-full text-xs">
                <thead class="bg-gray-50 sticky top-0">
                  <tr>
                    <th class="px-2 py-1.5 text-left text-xs font-semibold text-gray-700 uppercase">Trạng thái</th>
                    <th class="px-2 py-1.5 text-left text-xs font-semibold text-gray-700 uppercase">SL</th>
                    <th class="px-2 py-1.5 text-left text-xs font-semibold text-gray-700 uppercase">%</th>
                  </tr>
                </thead>
                <tbody id="f7-status-table-body" class="divide-y divide-gray-200">
                  <tr>
                    <td colspan="3" class="px-2 py-3 text-center text-gray-500 text-xs">Chưa có dữ liệu</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Phân bổ Task và Task đến hạn - Grid 2 cột -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- Phân bổ Task - Biểu đồ tròn (1/2 width) -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4">
              <span class="material-icons text-indigo-600 text-xl">pie_chart</span>
              <h3 class="text-lg font-semibold text-gray-900">Phân bổ Task theo Người thực hiện</h3>
            </div>
            <div id="f7-chart-assignee" class="min-h-[300px] flex items-center justify-center">
              <p class="text-gray-500 text-center">Chưa có dữ liệu</p>
            </div>
          </div>

          <!-- Task đến hạn (1/2 width) -->
          <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-2 mb-4">
              <span class="material-icons text-red-600 text-xl">schedule</span>
              <h3 class="text-lg font-semibold text-gray-900">Các Task đến hạn</h3>
            </div>
            <div id="f7-due-tasks" class="min-h-[300px]">
              <p class="text-gray-500 text-center py-8">Chưa có dữ liệu</p>
            </div>
          </div>
        </div>

        <!-- Assignee Details -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <div class="flex items-center gap-2 mb-4">
            <span class="material-icons text-green-600 text-xl">person</span>
            <h3 class="text-lg font-semibold text-gray-900">Chi tiết theo từng Người thực hiện</h3>
          </div>
          <div id="f7-assignee-tags" class="flex flex-wrap gap-2 mb-4">
            <!-- Tags sẽ được render ở đây -->
          </div>
          <div id="f7-assignee-details" class="min-h-[200px]">
            <p class="text-gray-500 text-center py-8">Vui lòng chọn người thực hiện để xem chi tiết</p>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Upload Modal -->
  <div id="upload-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="upload-title">
    <div class="w-full max-w-lg bg-white rounded-2xl border-2 border-gray-200 shadow-2xl overflow-hidden transform transition-all">
      <div class="px-6 py-4 bg-gradient-to-r from-red-50 to-white border-b-2 border-gray-200">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-primary-blue rounded-lg">
            <span class="material-icons text-white text-lg">upload_file</span>
          </div>
          <h3 id="upload-title" class="text-lg font-bold text-gray-800">Gửi báo cáo</h3>
        </div>
      </div>
      <div class="p-6 space-y-4">
        <div class="flex flex-wrap gap-2 text-sm">
          <span class="px-4 py-2 rounded-full bg-gradient-to-r from-red-50 to-red-100 border-2 border-red-200 font-medium shadow-sm">Người nộp: <b class="ml-1 text-primary-blue" id="uploader-name"></b></span>
          <span class="px-4 py-2 rounded-full bg-gradient-to-r from-red-50 to-red-100 border-2 border-red-200 font-medium shadow-sm">Mã: <b class="ml-1 text-primary-blue" id="uploader-code"></b></span>
          <span class="px-4 py-2 rounded-full bg-gradient-to-r from-red-50 to-red-100 border-2 border-red-200 font-medium shadow-sm">Tác vụ: <b class="ml-1 text-primary-blue" id="uploader-task"></b></span>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
            <span class="material-icons text-primary-blue text-lg">attach_file</span>
            <span>Chọn tệp báo cáo</span>
          </label>
          <input id="upload-file" type="file" class="block w-full text-sm file:mr-2 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary-blue file:text-white file:font-semibold file:shadow-md hover:file:shadow-lg file:transition-all"/>
          <p class="text-xs text-gray-500 mt-2 flex items-center gap-1">
            <span class="material-icons text-xs">info</span>
            <span>Tệp sẽ gửi kèm timestamp tại thời điểm gửi.</span>
          </p>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
            <span class="material-icons text-primary-blue text-lg">note</span>
            <span>Ghi chú (tùy chọn)</span>
          </label>
          <textarea id="upload-note" rows="3" placeholder="Nhập ghi chú về báo cáo..." class="w-full border-2 border-red-300 rounded-lg bg-white p-3 focus:outline-none focus:ring-2 focus:ring-red-200 focus:border-primary-blue transition-all"></textarea>
          <p class="text-xs text-gray-500 mt-2 flex items-center gap-1">
            <span class="material-icons text-xs">info</span>
            <span>Ghi chú sẽ được gửi kèm với báo cáo.</span>
          </p>
        </div>
        <div id="bps-option" class="flex items-center gap-2" style="display:none">
          <input id="upload-bps" type="checkbox" class="h-4 w-4">
          <label for="upload-bps" class="text-sm text-gray-700 select-none">Trả báo cáo BPS</label>
        </div>
      </div>
      <div class="px-6 py-4 border-t-2 border-gray-200 bg-gray-50 flex justify-end gap-3">
        <button id="btn-cancel" class="px-5 py-2.5 rounded-lg bg-white border-2 border-gray-300 text-gray-700 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 font-medium shadow-sm">Huỷ</button>
        <button id="btn-send" class="px-6 py-2.5 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105 shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2">
          <span class="material-icons text-sm">send</span>
          <span>Gửi báo cáo</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Chi tiết tác vụ theo nhân viên (Form 2 P1) -->
  <div id="f2-p1-detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="f2-p1-detail-title">
    <div class="w-full max-w-[95vw] bg-white rounded-2xl border-2 border-gray-200 shadow-2xl overflow-hidden" style="width:95vw">
      <div class="px-6 py-4 bg-gradient-to-r from-red-50 to-white border-b-2 border-gray-200 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-primary-blue rounded-lg">
            <span class="material-icons text-white">person</span>
          </div>
          <h3 id="f2-p1-detail-title" class="text-lg font-bold text-gray-800">Chi tiết tác vụ của <span id="f2-p1-detail-name" class="text-primary-blue"></span></h3>
        </div>
        <button id="f2-p1-detail-close" class="px-4 py-2 rounded-lg bg-white border-2 border-gray-300 text-gray-700 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 font-medium shadow-sm flex items-center gap-2">
          <span class="material-icons text-sm">close</span>
          <span>Đóng</span>
        </button>
      </div>
      <div class="p-6">
        <div class="overflow-auto border-2 border-gray-200 rounded-xl shadow-inner" style="max-height:60vh">
          <table class="min-w-[1200px] w-full text-sm">
            <thead class="bg-gradient-to-r from-red-100 via-red-50 to-red-100 sticky top-0 z-10 shadow-sm">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2 min-w-[140px]">Tình trạng</th>
                <th class="px-3 py-2 min-w-[160px]">Ngày hoàn thành thực tế</th>
                <th class="px-3 py-2 min-w-[140px]">Mã</th>
                <th class="px-3 py-2 min-w-[260px]">Tên tác vụ</th>
                <th class="px-3 py-2 min-w-[160px]">Người yêu cầu</th>
                <th class="px-3 py-2 min-w-[140px]">Ngày yêu cầu</th>
                <th class="px-3 py-2 min-w-[140px]">Hạn mong muốn</th>
                <th class="px-3 py-2 min-w-[240px]">Note</th>
              </tr>
            </thead>
            <tbody id="f2-p1-detail-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="detail-title">
    <div class="w-full max-w-5xl bg-white rounded-2xl border-2 border-gray-200 shadow-2xl overflow-hidden">
      <div class="px-6 py-4 bg-gradient-to-r from-red-50 to-white border-b-2 border-gray-200 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-primary-blue rounded-lg">
            <span class="material-icons text-white">assignment</span>
          </div>
          <h3 id="detail-title" class="text-lg font-bold text-gray-800">Nhiệm vụ của <span id="detail-name" class="text-primary-blue"></span></h3>
        </div>
        <button id="detail-close" class="px-4 py-2 rounded-lg bg-white border-2 border-gray-300 text-gray-700 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 font-medium shadow-sm flex items-center gap-2">
          <span class="material-icons text-sm">close</span>
          <span>Đóng</span>
        </button>
      </div>
      <div class="p-6">
        <div class="overflow-x-auto border-2 border-gray-200 rounded-xl shadow-inner">
          <table class="min-w-[900px] w-full text-sm">
            <thead class="bg-gradient-to-r from-red-100 via-red-50 to-red-100 sticky top-0 z-10 shadow-sm">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">Mã</th>
                <th class="px-3 py-2">Tên tác vụ</th>
                <th class="px-3 py-2">Trạng thái</th>
                <th class="px-3 py-2">Công chuẩn</th>
                <th class="px-3 py-2">Ngày yêu cầu</th>
                <th class="px-3 py-2">Hạn mong muốn</th>
                <th class="px-3 py-2">Hạn đáp ứng</th>
                <th class="px-3 py-2">Ngày hoàn thành</th>
              </tr>
            </thead>
            <tbody id="detail-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Chưa có dữ liệu</td></tr>
            </tbody>
          </table>
        </div>
        <p class="text-xs text-gray-500 mt-2" id="detail-note"></p>
      </div>
    </div>
  </div>


  <div id="toast" class="toast"></div>

  <script>
    // Constants
    const WEBHOOK_URL = "https://xcqiyibqs.tino.page/webhook/tracuutacvuNCTN2";
    const FORM2_WEBHOOK_URL = "https://xcqiyibqs.tino.page/webhook/Tracuutongtacvu";
    const FORM1_UPLOAD_URL = "https://xcqiyibqs.tino.page/webhook/TrabaocaoNTCN2";
    let F4_CHART = null;

    // Hàm format timestamp theo định dạng DD HH:mm GMT+7
    function formatTimestampGMT7() {
      const now = new Date();
      // Chuyển đổi sang GMT+7 (UTC+7)
      const gmt7 = new Date(now.getTime() + (7 * 60 * 60 * 1000));
      
      const year = gmt7.getUTCFullYear();
      const month = String(gmt7.getUTCMonth() + 1).padStart(2, '0');
      const day = String(gmt7.getUTCDate()).padStart(2, '0');
      const hours = String(gmt7.getUTCHours()).padStart(2, '0');
      const minutes = String(gmt7.getUTCMinutes()).padStart(2, '0');
      
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    // Sidebar navigation
    const navBtns = document.querySelectorAll('.nav-btn');
    const sections = ['form1', 'form2', 'form3', 'form6', 'form7'].map(id=>document.getElementById(id));
    function showSection(id){ 
      sections.forEach(s=>s.classList.toggle('hidden', s.id!==id));
      // Tự động cập nhật dashboard Form 6 khi được mở
      if (id === 'form6' && typeof updateF6Dashboard === 'function') {
        // Đợi một chút để đảm bảo DOM đã render
        setTimeout(() => {
          updateF6Dashboard();
        }, 100);
      }
    }
    navBtns.forEach((btn)=>{
      btn.onclick=()=>{
        navBtns.forEach(b=>b.classList.remove('bg-primary-blue','font-bold'));
        btn.classList.add('bg-primary-blue','font-bold');
        const target = btn.getAttribute('data-target');
        showSection(target);
        
      }
    });
    // Default
    navBtns[0].classList.add('bg-primary-blue','font-bold');
    showSection(navBtns[0].getAttribute('data-target'));

    // Names - Form 1
    const FORM1_NAMES = [
      "Trần Văn Hoàng",
      "Nguyễn Kim Cương",
      "Trịnh Xuân Hạnh",
      "Đỗ Xuân Huy",
      "Giang Văn Toàn",
      "Vũ Ngọc Diệp",
      "Bùi Ngọc Hùng",
      "Nguyễn Thế Việt",
      "Nguyễn Mạnh Quang",
    ];

    // Names - Form 2 (NCTN 2) - Danh sách riêng biệt
    const FORM2_NAMES = [
      "Trần Văn Hoàng",
      "Nguyễn Kim Cương", 
      "Trịnh Xuân Hạnh",
      "Đỗ Xuân Huy",
      "Giang Văn Toàn",
      "Vũ Ngọc Diệp",
      "Bùi Ngọc Hùng",
      "Nguyễn Thế Việt",
      "Nguyễn Mạnh Quang",
    ];
    

    // Dữ liệu tác vụ (khởi tạo rỗng; sẽ nối nguồn thật sau)
    const demoTasksForm1 = {};
    

    // Fill selects
    function fillSelect(sel, arr){ arr.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
    fillSelect(document.getElementById('f1-name'), FORM1_NAMES);

    // Fill month dropdown
    function fillMonthSelect(){
      const monthSelect = document.getElementById('f1-month');
      if (!monthSelect) return;
      
      const months = [];
      const now = new Date();
      
      // Tạo danh sách 12 tháng gần nhất (bao gồm tháng hiện tại)
      for (let i = 0; i < 12; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const monthName = date.toLocaleDateString('vi-VN', { month: 'long', year: 'numeric' });
        const value = `${year}-${month}`;
        months.push({ value, text: monthName });
      }
      
      months.forEach(m => {
        const option = document.createElement('option');
        option.value = m.value;
        option.textContent = m.text;
        monthSelect.appendChild(option);
      });
    }
    fillMonthSelect();

    // Toast
    const toastEl = document.getElementById('toast');
    function showToast(msg,type='info'){
      toastEl.textContent = msg;
      toastEl.style.background = type==='success' ? '#137a39' : (type==='error' ? '#b42318' : '#0b1324');
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2600);
    }

    // Escape HTML để tránh XSS
    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    // Upload modal
    const modal = document.getElementById('upload-modal');
    const fileInput = document.getElementById('upload-file');
    const uploaderName = document.getElementById('uploader-name');
    const uploaderCode = document.getElementById('uploader-code');
    const uploaderTask = document.getElementById('uploader-task');
    let uploadContext = null;
    let isModalSubmitting = false;
    let lastOpenTrigger = null;
    function openUploadModal(ctx){
      uploadContext = ctx || {};
      uploaderName.textContent = ctx?.name || '';
      uploaderCode.textContent = ctx?.code || '';
      uploaderTask.textContent = ctx?.taskName || '';
      // Hide Người nộp pill no longer needed (Form 2 removed)
      try {
        const namePill = uploaderName && uploaderName.parentElement && uploaderName.parentElement.parentElement ? uploaderName.parentElement.parentElement : null;
        if (namePill) namePill.style.display = '';
        const bpsOption = document.getElementById('bps-option');
        const bpsCheckbox = document.getElementById('upload-bps');
        if (bpsOption) bpsOption.style.display = 'none';
        if (bpsCheckbox) bpsCheckbox.checked = false;
      } catch(_) {}
      fileInput.value = '';
      const noteInput = document.getElementById('upload-note');
      if (noteInput) noteInput.value = '';
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function closeUploadModal(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      // Re-enable last trigger and reset submit button state
      if (lastOpenTrigger) {
        try {
          lastOpenTrigger.disabled = false;
          if (lastOpenTrigger.classList) lastOpenTrigger.classList.remove('opacity-50','pointer-events-none');
        } catch(_) {}
        lastOpenTrigger = null;
      }
      const sendBtn = document.getElementById('btn-send');
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Gửi báo cáo';
      }
      isModalSubmitting = false;
    }
    document.getElementById('btn-cancel').onclick = closeUploadModal;
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeUploadModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeUploadModal(); });

    document.getElementById('btn-send').onclick = async ()=>{
      if (isModalSubmitting) return;
      if(!fileInput.files || fileInput.files.length===0){ showToast('Vui lòng chọn tệp báo cáo.','error'); return; }
      const btn = document.getElementById('btn-send');
      isModalSubmitting = true;
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>Đang gửi..."; }
      const fd = new FormData();
      fd.append('file', fileInput.files[0]);
      fd.append('file_name', fileInput.files[0].name || '');
      fd.append('timestamp', formatTimestampGMT7());
      if(uploadContext){
        fd.append('nguoi_nop', uploadContext.name||'');
        fd.append('ma_tac_vu', uploadContext.code||'');
        fd.append('ten_tac_vu', uploadContext.taskName||'');
        fd.append('form', uploadContext.form||'');
      }
      const noteInput = document.getElementById('upload-note');
      const noteValue = noteInput ? (noteInput.value || '').trim() : '';
      fd.append('note', noteValue);
      fd.append('ghi_chu', noteValue);
      const bpsCheckbox = document.getElementById('upload-bps');
      fd.append('is_bps', '0');
      const targetUpload = FORM1_UPLOAD_URL;
      try{
        await fetch(targetUpload,{method:'POST',body:fd});
        showToast('Đã gửi báo cáo.','success');
        closeUploadModal();
      }
      catch(e){
        console.error(e);
        showToast('Gửi thất bại.','error');
        isModalSubmitting = false;
        if (btn) { btn.disabled = false; btn.textContent = 'Gửi báo cáo'; }
      }
    };

    // Helpers for tables
    function addTd(tr, text){ const td=document.createElement('td'); td.className='px-3 py-2 align-top'; td.textContent=text; tr.appendChild(td); }

    // Form 1: fetch via webhook with query for headers/fields
    let F1_ALL_ROWS = [];
    let F1_PAGE = 1;
    let F1_SIZE = 10;
    function applyForm1Paging(){
      const body = document.getElementById('f1-body');
      const pager = document.getElementById('f1-pager');
      const total = F1_ALL_ROWS.length;
      if(total === 0){
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="12">Không có tác vụ</td></tr>';
        pager.style.display = 'none';
        return;
      }
      pager.style.display = '';
      const maxPage = Math.max(1, Math.ceil(total / F1_SIZE));
      if(F1_PAGE > maxPage) F1_PAGE = maxPage;
      const start = (F1_PAGE - 1) * F1_SIZE;
      const end = Math.min(total, start + F1_SIZE);
      const slice = F1_ALL_ROWS.slice(start, end);
      const pageInfo = document.getElementById('f1-page-info');
      if(pageInfo) pageInfo.textContent = `Trang ${F1_PAGE}/${maxPage} (${total} dòng)`;
      const prev = document.getElementById('f1-prev');
      const next = document.getElementById('f1-next');
      if(prev) prev.disabled = (F1_PAGE <= 1);
      if(next) next.disabled = (F1_PAGE >= maxPage);
      // render rows
      body.innerHTML = '';
      slice.forEach(tr => body.appendChild(tr));
    }

    let F1_UNASSIGNED_MODE = false;
    let F1_MONTH_FILTER = '';
    let F1_ALL_DATA = []; // Lưu tất cả dữ liệu gốc để lọc cục bộ

    // Hàm lọc cục bộ theo tháng
    function applyLocalMonthFilter() {
      if (!F1_ALL_DATA.length) return;
      
      const getV = (obj, keys) => {
        const lower = Object.keys(obj || {}).reduce((acc, k) => { acc[k.toLowerCase()] = obj[k]; return acc; }, {});
        for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
        return '';
      };

      let filteredData = [...F1_ALL_DATA];

      // Lọc theo tháng nếu có bộ lọc
      if (F1_MONTH_FILTER) {
        filteredData = filteredData.filter(item => {
          const statusText = String(getV(item, ['status', 'trangthai', 'trang_thai', 'trạng thái']) || '').toLowerCase();
          const isDoing = statusText.includes('doing') || statusText.includes('đang');
          
          // Tác vụ Doing luôn hiển thị (không bị lọc theo tháng)
          // Nhưng vẫn phải tuân theo lọc tên (đã được lọc từ server)
          if (isDoing) return true;
          
          // Các tác vụ khác lọc theo tháng
          const requestDate = getV(item, ['requestdate', 'ngayyeucau', 'ngay_yeu_cau', 'submissiondate', 'ngaygui', 'ngày yêu cầu']);
          if (!requestDate) return false;
          
          const date = new Date(requestDate);
          if (isNaN(date.getTime())) return false;
          
          const itemYear = date.getFullYear();
          const itemMonth = String(date.getMonth() + 1).padStart(2, '0');
          const itemMonthStr = `${itemYear}-${itemMonth}`;
          
          return itemMonthStr === F1_MONTH_FILTER;
        });
      }

      // Sắp xếp: Doing trước, sau đó theo thời gian từ gần đến xa
      filteredData.sort((a, b) => {
        const statusA = String(getV(a, ['status', 'trangthai', 'trang_thai', 'trạng thái']) || '').toLowerCase();
        const statusB = String(getV(b, ['status', 'trangthai', 'trang_thai', 'trạng thái']) || '').toLowerCase();
        
        const isDoingA = statusA.includes('doing') || statusA.includes('đang');
        const isDoingB = statusB.includes('doing') || statusB.includes('đang');
        
        // Ưu tiên Doing trước
        if (isDoingA && !isDoingB) return -1;
        if (!isDoingA && isDoingB) return 1;
        
        // Nếu cùng trạng thái, sắp xếp theo thời gian từ gần đến xa
        const getRequestDate = (item) => {
          const requestDate = getV(item, ['requestdate', 'ngayyeucau', 'ngay_yeu_cau', 'submissiondate', 'ngaygui', 'ngày yêu cầu']);
          if (!requestDate) return new Date(0); // Nếu không có ngày, đặt ở cuối
          
          const date = new Date(requestDate);
          return isNaN(date.getTime()) ? new Date(0) : date;
        };
        
        const dateA = getRequestDate(a);
        const dateB = getRequestDate(b);
        
        // Sắp xếp từ gần đến xa (mới nhất lên đầu)
        return dateB.getTime() - dateA.getTime();
      });

      // Render lại bảng với dữ liệu đã lọc
      renderFilteredData(filteredData);
    }

    // Hàm render dữ liệu đã lọc
    function renderFilteredData(data) {
      const body = document.getElementById('f1-body');
      const pager = document.getElementById('f1-pager');
      
      if (!data.length) {
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="15">Không có tác vụ</td></tr>';
        pager.style.display = 'none';
        return;
      }

      const getV = (obj, keys) => {
        const lower = Object.keys(obj || {}).reduce((acc, k) => { acc[k.toLowerCase()] = obj[k]; return acc; }, {});
        for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
        return '';
      };

      const nameSelected = (document.getElementById('f1-name').value || '').trim();

      F1_ALL_ROWS = [];
      data.forEach(item => {
        const tr = document.createElement('tr');
        const tdBtn = document.createElement('td'); 
        tdBtn.className = 'px-3 py-2';
        
        const code = getV(item, ['Mã tác vụ', 'code', 'ma', 'taskcode', 'mã']);
        const tname = getV(item, ['Task Name', 'taskname', 'ten_tac_vu', 'ten', 'name', 'title', 'tên tác vụ']);
        
        // Tạo nút Trả báo cáo - chỉ cho phép khi trạng thái Doing
        const statusText = getV(item, ['⁉️ Kết quả', 'Hiện trạng', 'status', 'trangthai', 'trang_thai', 'trạng thái']);
        const statusLower = (statusText || '').toLowerCase();
        const isDoing = statusLower.includes('doing') || statusLower.includes('đang');
        const isDone = statusLower.includes('hoàn') || statusLower.includes('done');
        const isCancelled = statusLower.includes('cancel') || statusLower.includes('hủy') || statusLower.includes('huỷ');
        const isEmptyStatus = statusLower.trim() === '';
        const isLocked = !isDoing; // Chỉ cho phép khi Doing

        const labelBtn = document.createElement('label');
        if (isLocked) {
          labelBtn.className = 'px-3 py-1 inline-block rounded-lg bg-gray-300 text-gray-500 cursor-not-allowed opacity-60 pointer-events-none';
          if (isCancelled) {
            labelBtn.textContent = 'Đã hủy';
          } else if (isDone) {
            labelBtn.textContent = 'Đã hoàn thành';
          } else if (isEmptyStatus) {
            labelBtn.textContent = 'Trạng thái trống';
          } else {
            labelBtn.textContent = 'Chỉ Doing mới được gửi';
          }
        } else {
          labelBtn.className = 'px-3 py-1 inline-block rounded-lg text-white bg-primary-blue hover:brightness-105 cursor-pointer';
          labelBtn.textContent = 'Trả báo cáo';
          labelBtn.onclick = (e) => {
            e.preventDefault();
            if (labelBtn.disabled) return;
            labelBtn.disabled = true;
            labelBtn.classList.add('opacity-50', 'pointer-events-none');
            lastOpenTrigger = labelBtn;
            openUploadModal({ form: 'Form 1', name: nameSelected, code, taskName: tname });
          };
        }
        
        tdBtn.appendChild(labelBtn);
        tr.appendChild(tdBtn);

        // Các cột khác
        const tdStatus = document.createElement('td'); 
        tdStatus.className = 'px-3 py-2';
        const s = (statusText || '').toLowerCase();
        const badge = document.createElement('span'); 
        badge.className = 'px-2 py-1 rounded text-xs ' + (s.includes('hoàn') || s.includes('done')
          ? 'bg-green-100 text-green-800'
          : (s.includes('cancel') || s.includes('hủy') || s.includes('huỷ') || s.includes('chờ') || s.includes('pending'))
            ? 'bg-yellow-100 text-yellow-800'
            : 'bg-blue-100 text-blue-800');
        badge.textContent = statusText || ''; 
        tdStatus.appendChild(badge); 
        tr.appendChild(tdStatus);

        // Thêm cột Ngày hoàn thành thực tế
        addTd(tr, getV(item, ['Ngày hoàn thành thực tế', 'completiondate', 'completeddate', 'ngayhoanthanh', 'ngay_hoan_thanh', 'completion', 'done_date', 'ngày hoàn thành']));

        addTd(tr, code);
        addTd(tr, tname);
        addTd(tr, getV(item, ['Người yêu cầu', 'requester', 'nguoiyeucau', 'nguoi_yeu_cau', 'assigner']) || getV(item, ['🖊️ Tên NCC ', 'ten_ncc', 'tên ncc']));
        addTd(tr, getV(item, ['Công chuẩn công việc nhận tuần 22', 'manhour', 'man_hour', 'congchuan', 'cong_chuan', 'workload', 'sogio', 'sogiocong', 'công chuẩn']));
        addTd(tr, getV(item, ['📆 Ngày yêu cầu ', 'requestdate', 'ngayyeucau', 'ngay_yeu_cau', 'submissiondate', 'ngaygui', 'ngày yêu cầu']));
        addTd(tr, getV(item, ['Hạn mong muốn ', 'wishdue', 'hanmongmuon', 'han_mong_muon', 'desireddue', 'hạn mong muốn']));
        addTd(tr, getV(item, ['actualdue', 'handapung', 'han_dap_ung', 'completiondate', 'hạn đáp ứng']));
        addTd(tr, getV(item, ['❓ Mục đích đánh giá ', 'purpose', 'mucdich', 'muc_dich', 'mục đích đánh giá', 'muc dich danh gia', 'mucdichdanhgia']));
        addTd(tr, getV(item, ['note', 'ghi_chu', 'ghichu']));
        addTd(tr, getV(item, ['specialtest', 'yeucau_test_dac_biet', 'yeu_cau_test_dac_biet']));
        addTd(tr, getV(item, ['reportform', 'form_bao_cao', 'form_bao_cao_danh_gia']));
        addTd(tr, getV(item, ['attachmentfilename', 'file_name', 'filename', 'tenfile', 'ten_file', 'tên file', 'tên file đính kèm', 'attachment', 'file']));

        // Highlight theo hạn mong muốn cho tác vụ Doing
        try {
          const wishDueStr = getV(item, ['Hạn mong muốn ', 'wishdue', 'hanmongmuon', 'han_mong_muon', 'desireddue', 'hạn mong muốn']);
          if (isDoing && wishDueStr) {
            const dueDate = parseDateFlexible(wishDueStr);
            if (!isNaN(dueDate.getTime())) {
              const ymd = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
              const today = new Date();
              const dueYmd = ymd(dueDate);
              const todayYmd = ymd(today);
              if (dueYmd < todayYmd) {
                tr.style.backgroundColor = '#FEE2E2'; // đỏ nhạt
              } else if (dueYmd === todayYmd) {
                tr.style.backgroundColor = '#FEF3C7'; // vàng nhạt
              }
            }
          }
        } catch(_) {}

        F1_ALL_ROWS.push(tr);
      });

      applyForm1Paging();
    }

    function fetchWithTimeout(resource, options = {}){
      const { timeout = 120000 } = options;
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), timeout);
      return fetch(resource, { ...options, signal: controller.signal })
        .finally(()=>clearTimeout(id));
    }

    async function renderForm1(){
      const unassigned = F1_UNASSIGNED_MODE === true;
      const nameSelected = (document.getElementById('f1-name').value || '').trim();
      const personParam = unassigned ? '' : nameSelected;
      const body = document.getElementById('f1-body');
      if(!unassigned && !nameSelected){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="15">Vui lòng chọn tên</td></tr>'; return; }
      body.innerHTML = "<tr><td colspan='15' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";
      try{
          const headerMapF1 = {
          header_btn: 'Nút nhập gửi báo cáo',
          header_requester: 'Người yêu cầu',
          header_requestDate: 'Ngày yêu cầu',
          header_wishDue: 'Hạn mong muốn',
          header_actualDue: 'Hạn đáp ứng',
          header_code: 'Mã',
          header_taskName: 'Tên tác vụ',
            header_manHour: 'Công chuẩn',
          header_purpose: 'Mục đích đánh giá',
          header_note: 'Note',
          header_specialTest: 'Yêu cầu test đặc biệt',
          header_reportForm: 'Form báo cáo đánh giá',
          header_status: 'Trạng thái',
          header_completionDate: 'Ngày hoàn thành thực tế',
          header_attachmentFileName: 'Tên file đính kèm',
          field_requester: 'requester',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskName: 'taskName',
            field_manHour: 'manHour',
          field_purpose: 'purpose',
          field_note: 'note',
          field_specialTest: 'specialTest',
          field_reportForm: 'reportForm',
          field_status: 'status',
          field_completionDate: 'completionDate',
          field_attachmentFileName: 'attachmentFileName'
        };
        const params = new URLSearchParams({
          ...headerMapF1,
          action: 'form1_lookup',
          person_name: personParam,
          timestamp: formatTimestampGMT7()
        });
        const testUrl = `${WEBHOOK_URL}?${params.toString()}`;
        async function fetchJson(url){
          // Retry nhẹ: tối đa 2 lần khi lỗi mạng/timeout
          const maxAttempts = 2;
          let lastErr = null;
          for (let attempt = 1; attempt <= maxAttempts; attempt++){
            try{
              const r = await fetchWithTimeout(url, { 
                method: 'GET', 
                timeout: 120000,
                mode: 'cors',
                headers: {
                  'Accept': 'application/json, text/plain, */*',
                  'Content-Type': 'application/json'
                }
              });
              const text = await r.text();
              if(!r.ok) throw new Error(text || `HTTP ${r.status}`);
              let parsed = null; try{ parsed = JSON.parse(text); }catch{ parsed = null; }
              return { parsed, raw: text };
            }catch(e){
              lastErr = e;
              if (attempt < maxAttempts) {
                // chờ ngắn trước lần thử tiếp
                await new Promise(res=>setTimeout(res, 1000));
                continue;
              }
              throw lastErr;
            }
          }
        }
        let data = null; let firstErr = null;
        try{
          const { parsed, raw } = await fetchJson(testUrl);
          if (parsed && parsed.code === 0 && /could not be started/i.test(String(parsed.message||''))) {
            throw new Error('WEBHOOK_TEST_INACTIVE');
          }
          data = parsed ?? raw;
        } catch (e) {
          firstErr = e;
          // Fallback sang production webhook khi test webhook chưa bật lắng nghe
          const prodUrl = testUrl.replace('/webhook-test/', '/webhook/');
          try {
            const { parsed, raw } = await fetchJson(prodUrl);
            data = parsed ?? raw;
          } catch (e2) {
            // Nếu cả hai đều fail, thử với proxy CORS
            console.log('[Form1 Debug] Direct fetch failed, trying CORS proxy');
            const proxyUrls = [
              `https://api.allorigins.win/raw?url=${encodeURIComponent(prodUrl)}`,
              `https://cors.isomorphic-git.org/${prodUrl}`,
              `https://cors-anywhere.herokuapp.com/${prodUrl}`,
              `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(prodUrl)}`
            ];
            
            for (const proxyUrl of proxyUrls) {
              try {
                console.log('[Form1 Debug] Trying proxy:', proxyUrl);
                const { parsed, raw } = await fetchJson(proxyUrl);
                data = parsed ?? raw;
                break;
              } catch (e3) {
                console.log('[Form1 Debug] Proxy failed:', e3.message);
                continue;
              }
            }
            
            if (!data) {
              throw e2; // Throw original error if all proxies fail
            }
          }
        }
        function pickRows(json){
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data','rows','result','records','items','list'];
          for (const k of candidates){ if (Array.isArray(json?.[k])) return json[k]; }
          // Deep search first array of objects
          try{
            const queue = [json];
            const seen = new Set();
            while(queue.length){
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)){
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          }catch(_){ }
          return [];
        }
        let rows = pickRows(data);
        if(!rows.length){ body.innerHTML = "<tr><td colspan='15' class='px-3 py-3 text-center text-gray-500'>Không có tác vụ</td></tr>"; return; }
        const getV = (obj, keys)=>{
          const lower = Object.keys(obj||{}).reduce((acc,k)=>{ acc[k.toLowerCase()] = obj[k]; return acc; },{});
          for(const k of keys){ const v = lower[k.toLowerCase()]; if(v!==undefined) return v; }
          return '';
        };
        // Lọc bỏ các dòng không có Tên tác vụ (tránh rỗng thông tin)
        rows = rows.filter(item=> String(getV(item,['taskname','ten_tac_vu','ten','name','title','tên tác vụ'])||'').trim() !== '');
        if(!rows.length){ body.innerHTML = "<tr><td colspan='15' class='px-3 py-3 text-center text-gray-500'>Không có tác vụ</td></tr>"; return; }
        
        // Lưu dữ liệu gốc để lọc cục bộ
        F1_ALL_DATA = [...rows];
        
        // Áp dụng lọc cục bộ
        applyLocalMonthFilter();
      }catch(err){
        const isCors = /Failed to fetch|CORS|No 'Access-Control-Allow-Origin'|NetworkError|TypeError/.test(String(err && (err.message || err)));
        const msg = isCors
          ? 'Bị chặn bởi CORS. Đã thử nhiều proxy nhưng vẫn không thể kết nối. Vui lòng mở file qua web server (vd: Live Server) hoặc kiểm tra kết nối mạng.'
          : (String(err && err.name)==='AbortError') ? 'Quá thời gian chờ (120s). Vui lòng thử lại.' : `Lỗi tải dữ liệu: ${String(err.message||err)}`;
        body.innerHTML = `<tr><td colspan='15' class='px-3 py-3 text-center text-red-600'>${msg}</td></tr>`;
      }
    }
    document.getElementById('f1-name').onchange = ()=>{};
    const f1SearchBtn = document.getElementById('f1-search');
    if (f1SearchBtn) {
      let f1Busy = false;
      f1SearchBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f1Busy) return;
        f1Busy = true;
        f1SearchBtn.disabled = true;
        const prev = f1SearchBtn.textContent;
        f1SearchBtn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try { F1_UNASSIGNED_MODE = false; await renderForm1(); }
        finally {
          f1Busy = false;
          f1SearchBtn.disabled = false;
          f1SearchBtn.textContent = prev;
        }
      };
    }
    // Nút lọc các tác vụ chưa được phân công (tên trống)
    const f1UnassignedBtn = document.getElementById('f1-unassigned');
    if (f1UnassignedBtn) {
      let f1UBusy = false;
      f1UnassignedBtn.onclick = async (e)=>{
        e.preventDefault();
        if (f1UBusy) return;
        f1UBusy = true;
        F1_UNASSIGNED_MODE = true;
        f1UnassignedBtn.disabled = true;
        const prev = f1UnassignedBtn.textContent;
        f1UnassignedBtn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        try { await renderForm1(); }
        finally {
          f1UBusy = false;
          f1UnassignedBtn.disabled = false;
          f1UnassignedBtn.textContent = prev;
        }
      };
    }
    // Pagination events
    const f1Prev = document.getElementById('f1-prev');
    const f1Next = document.getElementById('f1-next');
    const f1Size = document.getElementById('f1-size');
    if (f1Prev) f1Prev.onclick = (e)=>{ e.preventDefault(); if(F1_PAGE>1){ F1_PAGE--; applyForm1Paging(); } };
    if (f1Next) f1Next.onclick = (e)=>{ e.preventDefault(); F1_PAGE++; applyForm1Paging(); };
    if (f1Size) f1Size.onchange = (e)=>{ F1_SIZE = parseInt(e.target.value||'10',10)||10; F1_PAGE=1; applyForm1Paging(); };

    // Month filter events - chỉ lọc cục bộ, không gọi server
    const f1Month = document.getElementById('f1-month');
    const f1ClearFilter = document.getElementById('f1-clear-filter');
    
    if (f1Month) {
      f1Month.addEventListener('change', (e) => {
        F1_MONTH_FILTER = e.target.value || '';
        F1_PAGE = 1; // Reset về trang đầu khi thay đổi bộ lọc
        applyLocalMonthFilter(); // Chỉ lọc cục bộ
      });
    }
    
    if (f1ClearFilter) {
      f1ClearFilter.addEventListener('click', (e) => {
        e.preventDefault();
        F1_MONTH_FILTER = '';
        if (f1Month) f1Month.value = '';
        F1_PAGE = 1; // Reset về trang đầu khi xóa bộ lọc
        applyLocalMonthFilter(); // Chỉ lọc cục bộ
      });
    }




    // Copy on click and open link for storage (Form 1)
    const f1StorageLink = document.getElementById('f1-storage-link');
    if (f1StorageLink) {
      f1StorageLink.addEventListener('click', async ()=>{
        const url = f1StorageLink.getAttribute('href') || '';
        try { await navigator.clipboard.writeText(url); showToast('Đã copy liên kết.','success'); }
        catch(_) { /* ignore copy error to not block open */ }
      });
    }

    // ===== Form 2: Tất cả tác vụ =====
    let F2_ALL_DATA = [];
    let F2_MONTH_FILTER = '';
    let F2_EMPLOYEE_STATS = {}; // Lưu thống kê theo nhân viên

    // Form 2: Month filter
    const f2Month = document.getElementById('f2-month');
    if (f2Month) {
      // Set default month to current month
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      f2Month.value = `${year}-${month}`;
      F2_MONTH_FILTER = f2Month.value;

      f2Month.addEventListener('change', (e) => {
        F2_MONTH_FILTER = e.target.value || '';
        console.log('[Form2 Debug] Month changed to:', F2_MONTH_FILTER);
        console.log('[Form2 Debug] F2_ALL_DATA length:', F2_ALL_DATA.length);
        // Dùng dữ liệu hiện có, không gọi lại server
        if (F2_ALL_DATA.length > 0) {
          calculateEmployeeStats(F2_ALL_DATA);
          renderForm2Stats();
          console.log('[Form2 Debug] Stats recalculated and rendered');
        } else {
          console.log('[Form2 Debug] No data available for recalculation');
        }
      });
    }

    // Form 2: Fetch data from same source as Form 1
    async function fetchForm2Data() {
      const body = document.getElementById('f2-body-p1');
      if (!body) return;

      body.innerHTML = "<tr><td colspan='10' class='px-3 py-3 text-center text-gray-500'><span class='spinner mr-2'></span>Đang tải...</td></tr>";

      try {
        const headerMapF2 = {
          // Headers cho modal (15 cột)
          header_btn: 'Nút nhập gửi báo cáo',
          header_status: 'Tình trạng',
          header_completionDate: 'Ngày hoàn thành thực tế',
          header_code: 'Mã',
          header_taskName: 'Tên tác vụ',
          header_requester: 'Người yêu cầu',
          header_manHour: 'Công chuẩn',
          header_requestDate: 'Ngày yêu cầu',
          header_wishDue: 'Hạn mong muốn',
          header_actualDue: 'Hạn đáp ứng',
          header_purpose: 'Mục đích đánh giá',
          header_note: 'Note',
          header_specialTest: 'Yêu cầu test đặc biệt',
          header_reportForm: 'Form báo cáo đánh giá',
          header_attachmentFileName: 'Tên file đính kèm',
          
          // Field mappings cho modal
          field_requester: 'requester',
          field_requestDate: 'requestDate',
          field_wishDue: 'wishDue',
          field_actualDue: 'actualDue',
          field_code: 'code',
          field_taskName: 'taskName',
          field_manHour: 'manHour',
          field_purpose: 'purpose',
          field_note: 'note',
          field_specialTest: 'specialTest',
          field_reportForm: 'reportForm',
          field_status: 'status',
          field_completionDate: 'completionDate',
          field_attachmentFileName: 'attachmentFileName',
          
          // Additional fields for comprehensive data
          field_assignee: 'assignee',
          field_progress: 'progress',
          field_priority: 'priority',
          field_category: 'category',
          field_department: 'department',
          field_project: 'project',
          field_estimatedHours: 'estimatedHours',
          field_actualHours: 'actualHours',
          field_createdDate: 'createdDate',
          field_updatedDate: 'updatedDate',
          field_createdBy: 'createdBy',
          field_updatedBy: 'updatedBy',
          field_tags: 'tags',
          field_comments: 'comments',
          field_attachments: 'attachments',
          field_relatedTasks: 'relatedTasks',
          field_dependencies: 'dependencies',
          field_riskLevel: 'riskLevel',
          field_complexity: 'complexity',
          field_qualityScore: 'qualityScore',
          field_feedback: 'feedback',
          field_lessonsLearned: 'lessonsLearned',
          field_nextSteps: 'nextSteps',
          field_resources: 'resources',
          field_tools: 'tools',
          field_methodology: 'methodology',
          field_standards: 'standards',
          field_compliance: 'compliance',
          field_approvalStatus: 'approvalStatus',
          field_approver: 'approver',
          field_approvalDate: 'approvalDate',
          field_reviewStatus: 'reviewStatus',
          field_reviewer: 'reviewer',
          field_reviewDate: 'reviewDate',
          field_testStatus: 'testStatus',
          field_tester: 'tester',
          field_testDate: 'testDate',
          field_deploymentStatus: 'deploymentStatus',
          field_deploymentDate: 'deploymentDate',
          field_performance: 'performance',
          field_metrics: 'metrics',
          field_kpis: 'kpis',
          field_sla: 'sla',
          field_budget: 'budget',
          field_cost: 'cost',
          field_roi: 'roi',
          field_impact: 'impact',
          field_benefits: 'benefits',
          field_challenges: 'challenges',
          field_solutions: 'solutions',
          field_recommendations: 'recommendations'
        };

        // Lấy tên người hiện tại (có thể từ Form 1 hoặc mặc định)
        const currentPersonName = (document.getElementById('f1-name')?.value || '').trim() || 'Tất cả';
        
        const params = new URLSearchParams({
          ...headerMapF2,
          action: 'form2_all_tasks', // Action riêng cho Form 2
          person_name: currentPersonName, // Thêm tên người vào query
          month: F2_MONTH_FILTER || '',
          timestamp: formatTimestampGMT7()
        });

        const baseUrl = `${FORM2_WEBHOOK_URL}?${params.toString()}`;

        async function fetchJsonWithProxyChain(base) {
        // Thử JSONP trước (hoạt động với file://)
        const jsonpPromise = new Promise((resolve, reject) => {
          const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
          const script = document.createElement('script');
          const url = base + (base.includes('?') ? '&' : '?') + 'callback=' + callbackName;
          
          window[callbackName] = function(data) {
            document.head.removeChild(script);
            delete window[callbackName];
            resolve({ parsed: data, source: 'jsonp' });
          };
          
          script.onerror = function() {
            document.head.removeChild(script);
            delete window[callbackName];
            reject(new Error('JSONP_FAILED'));
          };
          
          script.src = url;
          document.head.appendChild(script);
          
          // Timeout sau 30 giây
          setTimeout(() => {
            if (document.head.contains(script)) {
              document.head.removeChild(script);
              delete window[callbackName];
              reject(new Error('JSONP_TIMEOUT'));
            }
          }, 30000);
        });

        try {
          console.log('[Form2 Debug] Trying JSONP:', base);
          const result = await jsonpPromise;
          if (result.parsed && hasMeaningfulRows(result.parsed)) {
            console.log('[Form2 Debug] JSONP succeeded');
            return result;
          }
        } catch (e) {
          // Chỉ log nếu không phải timeout (timeout là bình thường khi JSONP không được hỗ trợ)
          if (e.message !== 'JSONP_TIMEOUT') {
            console.log('[Form2 Debug] JSONP failed:', e.message);
          }
        }

        // Fallback: Thử fetch trực tiếp - ưu tiên webhook chính trước
        const urlProd = base.includes('/webhook/') ? base : base.replace('/webhook-test/', '/webhook/');
        const urlTest = base.includes('/webhook-test/') ? base : base.replace('/webhook/', '/webhook-test/');
        // Ưu tiên webhook chính trước để tránh lỗi CORS không cần thiết
        const urls = [urlProd, urlTest];
        
        let lastErr = null;
        const hasMeaningfulRows = (obj)=>{
          if (Array.isArray(obj)) return obj.length > 0 && typeof obj[0] === 'object';
          if (!obj || typeof obj !== 'object') return false;
          const keys = ['data','rows','result','records','items','list'];
          for (const k of keys) {
            const v = obj[k];
            if (Array.isArray(v) && v.length && typeof v[0] === 'object') return true;
          }
          try {
            for (const v of Object.values(obj)) {
              if (Array.isArray(v) && v.length && typeof v[0] === 'object') return true;
            }
          } catch(_){}
          return false;
        };

        for (const url of urls) {
          try {
            console.log('[Form2 Debug] Fetching:', url);
            const r = await fetch(url, { 
              method: 'GET',
              headers: {
                'Accept': 'application/json, text/plain, */*',
                'Content-Type': 'application/json'
              },
              // Thêm mode để xử lý CORS tốt hơn
              mode: 'cors'
            });
            const text = await r.text();
            if (!r.ok) throw new Error(`HTTP ${r.status}: ${text}`);
            if (!text || text.trim().length === 0) throw new Error('EMPTY_RESPONSE');
            
            let parsed = null;
            try { parsed = JSON.parse(text); } catch { parsed = null; }
            
            if (parsed && parsed.code === 0 && /could not be started/i.test(String(parsed.message||''))) {
              throw new Error('WEBHOOK_TEST_INACTIVE');
            }
            if (!parsed) throw new Error('INVALID_JSON');
            if (!hasMeaningfulRows(parsed)) throw new Error('NO_ROWS_FOUND');
            console.log('[Form2 Debug] Successfully fetched from:', url);
            return { parsed, source: url };
          } catch (e) {
            lastErr = e;
            // Chỉ log lỗi CORS nếu không phải là lỗi CORS (để tránh spam console)
            if (!e.message.includes('CORS') && !e.message.includes('Failed to fetch')) {
              console.log('[Form2 Debug] Fetch failed:', e.message);
            }
            // Nếu đã thành công với URL đầu tiên, không cần thử URL thứ hai
            continue;
          }
        }
        throw lastErr || new Error('FETCH_FAILED');
        }

        let data = null; let sourceUsed = '';
        try {
          const result = await fetchJsonWithProxyChain(baseUrl);
          data = result.parsed; sourceUsed = result.source;
        } catch (e) {
          throw e;
        }

        function pickRows(json) {
          if (!json) return [];
          if (Array.isArray(json)) return json;
          const candidates = ['data', 'rows', 'result', 'records', 'items', 'list'];
          for (const k of candidates) { if (Array.isArray(json?.[k])) return json[k]; }
          try {
            const queue = [json];
            const seen = new Set();
            while (queue.length) {
              const cur = queue.shift();
              if (!cur || typeof cur !== 'object' || seen.has(cur)) continue;
              seen.add(cur);
              for (const v of Object.values(cur)) {
                if (Array.isArray(v) && v.length && typeof v[0] === 'object') return v;
                if (v && typeof v === 'object') queue.push(v);
              }
            }
          } catch (_) { }
          return [];
        }

        let rows = pickRows(data);
        console.log('[Form2 Debug] Raw data received:', Array.isArray(data) ? `Array(${data.length})` : (data && typeof data === 'object' ? 'Object' : typeof data), 'from:', sourceUsed || 'unknown');
        console.log('[Form2 Debug] Extracted rows count:', rows.length);
        console.log('[Form2 Debug] First few rows:', rows.slice(0, 3));
        
        // Khai báo getV function trước khi sử dụng
        const getV = (obj, keys) => {
          const lower = Object.keys(obj || {}).reduce((acc, k) => { acc[k.toLowerCase()] = obj[k]; return acc; }, {});
          for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
          return '';
        };
        
        // (Hoãn) Không lưu dữ liệu gốc trước khi filter để tránh sai lệch khi tái tính theo tháng
        
        // Debug: Kiểm tra completionDate trong dữ liệu
        console.log('[Form2 Debug] Sample completionDate values:');
        let completionDateCount = 0;
        rows.slice(0, 5).forEach((item, index) => {
          const completionDate = getV(item, [
            'Ngày hoàn thành thực tế', 'ngày hoàn thành thực tế',
            'completionDate', 'completiondate', 'completedDate', 'completeddate',
            'completion_date', 'completed_date', 'done_date',
            'ngayhoanthanh', 'ngay_hoan_thanh', 'ngay_hoan_thanh_thuc_te'
          ]);
          console.log(`[Form2 Debug] Row ${index}:`, completionDate);
          if (completionDate) completionDateCount++;
        });
        
        // Đếm tổng số completionDate trong toàn bộ dữ liệu
        const totalCompletionDates = rows.filter(item => {
          const completionDate = getV(item, [
            'Ngày hoàn thành thực tế', 'ngày hoàn thành thực tế',
            'completionDate', 'completiondate', 'completedDate', 'completeddate',
            'completion_date', 'completed_date', 'done_date',
            'ngayhoanthanh', 'ngay_hoan_thanh', 'ngay_hoan_thanh_thuc_te'
          ]);
          return completionDate && String(completionDate).trim() !== '';
        }).length;
        console.log('[Form2 Debug] Total rows with completionDate:', totalCompletionDates, 'out of', rows.length);
        
        if (!rows.length) {
          console.log('[Form2 Debug] No rows found, showing empty message');
          body.innerHTML = "<tr><td colspan='11' class='px-3 py-3 text-center text-gray-500'>Không có tác vụ</td></tr>";
          return;
        }

        // Lọc bỏ các dòng không có Tên tác vụ (bổ sung 'Task Name')
        rows = rows.filter(item => String(getV(item, ['Task Name', 'taskname', 'ten_tac_vu', 'ten', 'name', 'title', 'tên tác vụ']) || '').trim() !== '');
        if (!rows.length) {
          body.innerHTML = "<tr><td colspan='11' class='px-3 py-3 text-center text-gray-500'>Không có tác vụ</td></tr>";
          return;
        }

        // Lưu dữ liệu gốc SAU KHI filter để đồng bộ tái tính khi đổi tháng
        F2_ALL_DATA = [...rows];
        console.log('[Form2 Debug] F2_ALL_DATA (filtered) saved with', F2_ALL_DATA.length, 'rows');

        // Tính toán thống kê theo nhân viên
        calculateEmployeeStats(rows);
        
        // Render bảng thống kê
        renderForm2Stats();
        
      } catch (err) {
        const isCors = /Failed to fetch|CORS|No 'Access-Control-Allow-Origin'|NetworkError|TypeError|JSONP_FAILED|JSONP_TIMEOUT/.test(String(err && (err.message || err)));
        const msg = isCors
          ? 'Bị chặn bởi CORS. Đã thử JSONP và fetch trực tiếp nhưng vẫn không thể kết nối. Vui lòng mở file qua web server (vd: Live Server) hoặc kiểm tra kết nối mạng.'
          : (String(err && err.name) === 'AbortError')
            ? 'Quá thời gian chờ (120s). Vui lòng thử lại.'
            : `Lỗi tải dữ liệu: ${String(err.message || err)}`;
        
        body.innerHTML = `<tr><td colspan='11' class='px-3 py-3 text-center text-red-600'>${msg}</td></tr>`;
      }
    }

    // Parser ngày linh hoạt: hỗ trợ YYYY-MM-DD[ HH:mm[:ss]], DD/MM/YYYY, DD-MM-YYYY, DD.MM.YYYY, YYYY/MM/DD
    function parseDateFlexible(input){
      const s = String(input || '').trim();
      if (!s) return new Date('');
      // ISO-like or YYYY-MM-DD
      let m = s.match(/^(\d{4})[-/.](\d{1,2})[-/.](\d{1,2})(?:[ T](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?$/);
      if (m) {
        const y = parseInt(m[1],10), mo = parseInt(m[2],10)-1, d = parseInt(m[3],10);
        const hh = parseInt(m[4]||'0',10), mm = parseInt(m[5]||'0',10), ss = parseInt(m[6]||'0',10);
        return new Date(y, mo, d, hh, mm, ss);
      }
      // DD/MM/YYYY or DD-MM-YYYY or DD.MM.YYYY
      m = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{4})(?:[ T](\d{1,2}):(\d{1,2})(?::(\d{1,2}))?)?$/);
      if (m) {
        const d = parseInt(m[1],10), mo = parseInt(m[2],10)-1, y = parseInt(m[3],10);
        const hh = parseInt(m[4]||'0',10), mm = parseInt(m[5]||'0',10), ss = parseInt(m[6]||'0',10);
        return new Date(y, mo, d, hh, mm, ss);
      }
      // Fallback native
      const dt = new Date(s);
      return dt;
    }

    // Tính toán thống kê theo nhân viên
    function calculateEmployeeStats(rows) {
      console.log('[Form2 Debug] calculateEmployeeStats called with F2_MONTH_FILTER:', F2_MONTH_FILTER);
      F2_EMPLOYEE_STATS = {};
      
      const getV = (obj, keys) => {
        const lower = Object.keys(obj || {}).reduce((acc, k) => { acc[k.toLowerCase()] = obj[k]; return acc; }, {});
        for (const k of keys) { const v = lower[k.toLowerCase()]; if (v !== undefined) return v; }
        return '';
      };

      // Chuẩn hoá chuỗi: bỏ dấu tiếng Việt, loại bỏ khoảng trắng/thanh nối để so khớp mềm
      const normalize = (s) => (s || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu, '')
        .replace(/\s|_/g, '');

      // Tìm field Ngày hoàn thành thực tế theo nhiều biến thể tên cột
      const getCompletionDateFromItem = (item) => {
        // 1) Thử các key phổ biến (ưu tiên)
        const valDirect = getV(item, [
          'Ngày hoàn thành thực tế', 'ngày hoàn thành thực tế',
          'Ngày hoàn thành', 'ngày hoàn thành',
          'completionDate', 'completiondate', 'completedDate', 'completeddate',
          'completion_date', 'completed_date', 'done_date',
          'ngayhoanthanh', 'ngay_hoan_thanh', 'ngay hoan thanh',
          'ngay_hoan_thanh_thuc_te', 'ngay hoan thanh thuc te'
        ]);
        if (valDirect) return valDirect;

        // 2) So khớp mềm: key chứa từ khoá "hoanthanh|completed|completion|done" và đồng thời chứa "ngay|date"
        try {
          const keys = Object.keys(item || {});
          for (const k of keys) {
            const nk = normalize(k);
            const hasComplete = /(hoanthanh|completed?|completion|done)/.test(nk);
            const hasDate = /(ngay|date)/.test(nk);
            if (hasComplete && hasDate) return item[k];
          }
        } catch(_) {}
        return '';
      };

      // Tìm field Ngày yêu cầu (request date) theo nhiều biến thể tên cột
      const getRequestDateFromItem = (item) => {
        const valDirect = getV(item, [
          '📆 Ngày yêu cầu ', 'Ngày yêu cầu', 'ngày yêu cầu',
          'requestDate', 'requestdate', 'submissiondate',
          'ngayyeucau', 'ngay_yeu_cau', 'ngay gui', 'ngaygui'
        ]);
        if (valDirect) return valDirect;
        try {
          const keys = Object.keys(item || {});
          for (const k of keys) {
            const nk = normalize(k);
            const hasReq = /(yeucau|request|submit|submission)/.test(nk);
            const hasDate = /(ngay|date)/.test(nk);
            if (hasReq && hasDate) return item[k];
          }
        } catch(_) {}
        return '';
      };

      // Tìm field Hạn mong muốn (wish due) theo nhiều biến thể tên cột
      const getWishDueFromItem = (item) => {
        const valDirect = getV(item, [
          'Hạn mong muốn ', 'Hạn mong muốn', 'hạn mong muốn',
          'wishDue', 'wishdue', 'desireddue',
          'hanmongmuon', 'han_mong_muon'
        ]);
        if (valDirect) return valDirect;
        try {
          const keys = Object.keys(item || {});
          for (const k of keys) {
            const nk = normalize(k);
            const hasWish = /(mongmuon|wish|desire)/.test(nk);
            const hasDue = /(han|due|deadline)/.test(nk);
            if (hasWish && hasDue) return item[k];
          }
        } catch(_) {}
        return '';
      };

      // Khởi tạo thống kê cho tất cả nhân viên trong danh sách Form 2
      FORM2_NAMES.forEach(name => {
        F2_EMPLOYEE_STATS[name] = {
          name: name,
          totalTasks: 0, // Tổng số tác vụ đang thực hiện (Doing)
          done: 0, // Số Done trong tháng được chọn
          ahead: 0,
          ontime: 0,
          late: 0,
          na: 0,
          tasks: []
        };
      });

      rows.forEach(item => {
        // Sử dụng danh sách fallback keys giống Form 5
        const assignee = getV(item, [
          'Assignee', 'Assignee Name', 'AssigneeName', 'Assignee name',
          'Phụ trách', 'Phụ trách chính', 'Người phụ trách', 'Người xử lý', 'Người nhận mẫu', 'Người nhận',
          'employee', 'nhanvien', 'nhan_vien', 'nhân viên', 'user', 'name', 'receiver', 'recipient', 'pic', 'nguoi_phu_trach', 'người phụ trách',
          'assignee', 'nguoi_nhan', 'người nhận', 'nguoi_thuc_hien', 'người thực hiện', 'name_1', 'Name 1'
        ]);
        
        if (!assignee || assignee.trim() === '') {
          return;
        }

        // Nếu tên không có trong danh sách, tạo mới để không bỏ sót dữ liệu
        if (!F2_EMPLOYEE_STATS[assignee]) {
          F2_EMPLOYEE_STATS[assignee] = {
            name: assignee,
            totalTasks: 0, // Tổng số tác vụ đang thực hiện (Doing)
            done: 0, // Số Done trong tháng được chọn
            ahead: 0,
            ontime: 0,
            late: 0,
            na: 0,
            tasks: []
          };
        }

        // Đếm tổng số tác vụ đang thực hiện (chỉ trạng thái Doing)
        const status = getV(item, ['⁉️ Kết quả', 'status', 'trangthai', 'trang_thai', 'trạng thái', 'ket_qua', 'result']);
        const statusLower = (status || '').toLowerCase();
        const isDoing = statusLower.includes('doing') || statusLower.includes('đang');
        
        if (isDoing) {
          F2_EMPLOYEE_STATS[assignee].totalTasks++;
        }

        const isDone = statusLower.includes('hoàn') || statusLower.includes('done');
        
        // Tính toán tiến độ
        const requestDate = getRequestDateFromItem(item);
        const wishDue = getWishDueFromItem(item);
        const completionDate = getCompletionDateFromItem(item);
        
        // Đếm Done trong phạm vi tháng đang lọc (hoặc tất cả nếu không lọc) và chỉ phân loại cho những tác vụ được đếm
        let isCountedDone = false;
        if (completionDate) {
          const compDate = parseDateFlexible(completionDate);
          if (!isNaN(compDate.getTime())) {
            if (F2_MONTH_FILTER) {
              const compYear = compDate.getFullYear();
              const compMonth = String(compDate.getMonth() + 1).padStart(2, '0');
              const compMonthStr = `${compYear}-${compMonth}`;
              if (compMonthStr === F2_MONTH_FILTER) {
                F2_EMPLOYEE_STATS[assignee].done++;
                isCountedDone = true;
              }
            } else {
              F2_EMPLOYEE_STATS[assignee].done++;
              isCountedDone = true;
            }
          }
        }

        // Chỉ tính Vượt/Đúng/Chậm/N/A cho các tác vụ Done đã được tính vào mẫu số (isCountedDone)
        if (isCountedDone) {
          if (requestDate && wishDue && completionDate) {
            const reqDate = parseDateFlexible(requestDate);
            const wishDate = parseDateFlexible(wishDue);
            const compDate = parseDateFlexible(completionDate);
            if (!isNaN(reqDate.getTime()) && !isNaN(wishDate.getTime()) && !isNaN(compDate.getTime())) {
              const daysDiff = (compDate.getTime() - wishDate.getTime()) / (1000 * 60 * 60 * 24);
              if (daysDiff < 0) {
                F2_EMPLOYEE_STATS[assignee].ahead++;
              } else if (daysDiff <= 1) {
                F2_EMPLOYEE_STATS[assignee].ontime++;
              } else {
                F2_EMPLOYEE_STATS[assignee].late++;
              }
            } else {
              F2_EMPLOYEE_STATS[assignee].na++;
            }
          } else {
            F2_EMPLOYEE_STATS[assignee].na++;
          }
        }

        // Lưu thông tin tác vụ đầy đủ cho modal với mapping JSON mới
        const reqDateStr = getRequestDateFromItem(item);
        const wishDueStr = getWishDueFromItem(item);
        const completionDateStr = getCompletionDateFromItem(item);
        F2_EMPLOYEE_STATS[assignee].tasks.push({
          // Core fields cho modal (8 cột) - Mapping chính xác theo yêu cầu
          code: getV(item, ['🆔 Mã Báo cáo', 'Mã tác vụ', 'code', 'ma', 'taskcode', 'mã', 'mã_báo_cáo']),
          taskName: getV(item, ['Task Name', 'taskname', 'ten_tac_vu', 'ten', 'name', 'title', 'tên tác vụ']),
          requester: getV(item, ['Người yêu cầu', '🖊️ Tên NCC ', 'requester', 'nguoiyeucau', 'nguoi_yeu_cau', 'assigner', 'người yêu cầu']),
          requestDate: reqDateStr,
          wishDue: wishDueStr,
          note: getV(item, ['Ghi chú', 'note', 'ghi_chu', 'ghichu', 'comments', 'bình_luận']),
          completionDate: completionDateStr,
          status: status,
          progress: calculateProgress(reqDateStr, wishDueStr, completionDateStr),
          
          // Additional fields từ JSON mới
          assigneeField: getV(item, ['Assignee', 'assignee', 'nguoi_nhan', 'người nhận', 'nguoi_thuc_hien', 'người thực hiện']),
          emailAssigner: getV(item, ['Email Assigner', 'email_assigner', 'email_nguoi_yeu_cau']),
          emailAssignee: getV(item, ['EmailofAssignee', 'email_assignee', 'email_nguoi_thuc_hien']),
          telegramMsgId: getV(item, ['TelegramMsgId', 'telegram_msg_id', 'telegram_message_id']),
          linkCongViec: getV(item, ['Link Công Việc', 'link_cong_viec', 'link_work']),
          logGuiCongViec: getV(item, ['Log gửi công việc', 'log_gui_cong_viec', 'log_send_work']),
          ketQua: getV(item, ['⁉️ Kết quả', 'ket_qua', 'result', 'status']),
          maBaoCao: getV(item, ['🆔 Mã Báo cáo', 'ma_bao_cao', 'report_code', 'report_id']),
          emailId: getV(item, ['Email ID', 'email_id']),
          name1: getV(item, ['Name 1', 'name_1', 'nguoi_thuc_hien']),
          email1: getV(item, ['Email 1', 'email_1']),
          linkBC: getV(item, ['LinkBC', 'link_bc', 'link_bao_cao']),
          nhanXetTruongNhom: getV(item, ['Nhận xét trưởng nhóm', 'nhan_xet_truong_nhom', 'team_lead_comment']),
          ngayBoSung: getV(item, ['Ngày bổ sung', 'ngay_bo_sung', 'supplement_date']),
          maPheDuyet: getV(item, ['Mã phê duyệt', 'ma_phe_duyet', 'approval_code']),
          nhanXetTruongPhong: getV(item, ['Nhận xét trưởng phòng', 'nhan_xet_truong_phong', 'department_head_comment']),
          
          // Test fields từ JSON
          ghiChu2a: getV(item, ['Ghi chú 2a', 'ghi_chu_2a']),
          diemNG3a: getV(item, ['3a Điểm NG ', 'diem_ng_3a', 'point_ng_3a']),
          ghiChu3a: getV(item, ['Ghi chú 3a', 'ghi_chu_3a']),
          testBen4a: getV(item, ['4a Test bền ', 'test_ben_4a', 'durability_test_4a']),
          ghiChu4a: getV(item, ['Ghi chú 4a', 'ghi_chu_4a']),
          baiTestKhac5a: getV(item, ['5a Bài test khác', 'bai_test_khac_5a', 'other_test_5a']),
          ghiChu5a: getV(item, ['Ghi chú 5a', 'ghi_chu_5a']),
          fileAttachment: getV(item, ['File attachment ', 'file_attachment', 'attachment_file']),
          
          // Additional comprehensive fields
          assignee: assignee,
          priority: getV(item, ['priority', 'độ_ưu_tiên', 'do_uu_tien', 'mức_độ_quan_trọng']),
          category: getV(item, ['category', 'loại', 'loai', 'phân_loại', 'phan_loai']),
          department: getV(item, ['department', 'phòng_ban', 'phong_ban', 'bộ_phận', 'bo_phan']),
          project: getV(item, ['project', 'dự_án', 'du_an', 'dự_án', 'du_an']),
          estimatedHours: getV(item, ['estimatedHours', 'estimated_hours', 'giờ_ước_tính', 'gio_uoc_tinh']),
          actualHours: getV(item, ['actualHours', 'actual_hours', 'giờ_thực_tế', 'gio_thuc_te']),
          createdDate: getV(item, ['createdDate', 'created_date', 'ngày_tạo', 'ngay_tao']),
          updatedDate: getV(item, ['updatedDate', 'updated_date', 'ngày_cập_nhật', 'ngay_cap_nhat']),
          createdBy: getV(item, ['createdBy', 'created_by', 'người_tạo', 'nguoi_tao']),
          updatedBy: getV(item, ['updatedBy', 'updated_by', 'người_cập_nhật', 'nguoi_cap_nhat']),
          tags: getV(item, ['tags', 'thẻ', 'the', 'nhãn', 'nhan']),
          comments: getV(item, ['comments', 'bình_luận', 'binh_luan', 'ghi_chú', 'ghi_chu']),
          attachments: getV(item, ['attachments', 'tệp_đính_kèm', 'tep_dinh_kem', 'file_attachments']),
          relatedTasks: getV(item, ['relatedTasks', 'related_tasks', 'tác_vụ_liên_quan', 'tac_vu_lien_quan']),
          dependencies: getV(item, ['dependencies', 'phụ_thuộc', 'phu_thuoc', 'ràng_buộc', 'rang_buoc']),
          riskLevel: getV(item, ['riskLevel', 'risk_level', 'mức_độ_rủi_ro', 'muc_do_rui_ro']),
          complexity: getV(item, ['complexity', 'độ_phức_tạp', 'do_phuc_tap', 'mức_độ_phức_tạp']),
          qualityScore: getV(item, ['qualityScore', 'quality_score', 'điểm_chất_lượng', 'diem_chat_luong']),
          feedback: getV(item, ['feedback', 'phản_hồi', 'phan_hoi', 'đánh_giá', 'danh_gia']),
          lessonsLearned: getV(item, ['lessonsLearned', 'lessons_learned', 'bài_học', 'bai_hoc', 'kinh_nghiệm']),
          nextSteps: getV(item, ['nextSteps', 'next_steps', 'bước_tiếp_theo', 'buoc_tiep_theo']),
          resources: getV(item, ['resources', 'tài_nguyên', 'tai_nguyen', 'nguồn_lực', 'nguon_luc']),
          tools: getV(item, ['tools', 'công_cụ', 'cong_cu', 'dụng_cụ', 'dung_cu']),
          methodology: getV(item, ['methodology', 'phương_pháp', 'phuong_phap', 'quy_trình', 'quy_trinh']),
          standards: getV(item, ['standards', 'tiêu_chuẩn', 'tieu_chuan', 'chuẩn_mực', 'chuan_muc']),
          compliance: getV(item, ['compliance', 'tuân_thủ', 'tuan_thu', 'tuân_thủ_quy_định']),
          approvalStatus: getV(item, ['approvalStatus', 'approval_status', 'trạng_thái_phê_duyệt', 'trang_thai_phe_duyet']),
          approver: getV(item, ['approver', 'người_phê_duyệt', 'nguoi_phe_duyet', 'người_duyệt']),
          approvalDate: getV(item, ['approvalDate', 'approval_date', 'ngày_phê_duyệt', 'ngay_phe_duyet']),
          reviewStatus: getV(item, ['reviewStatus', 'review_status', 'trạng_thái_đánh_giá', 'trang_thai_danh_gia']),
          reviewer: getV(item, ['reviewer', 'người_đánh_giá', 'nguoi_danh_gia', 'người_review']),
          reviewDate: getV(item, ['reviewDate', 'review_date', 'ngày_đánh_giá', 'ngay_danh_gia']),
          testStatus: getV(item, ['testStatus', 'test_status', 'trạng_thái_test', 'trang_thai_test']),
          tester: getV(item, ['tester', 'người_test', 'nguoi_test', 'người_kiểm_thử']),
          testDate: getV(item, ['testDate', 'test_date', 'ngày_test', 'ngay_test']),
          deploymentStatus: getV(item, ['deploymentStatus', 'deployment_status', 'trạng_thái_triển_khai', 'trang_thai_trien_khai']),
          deploymentDate: getV(item, ['deploymentDate', 'deployment_date', 'ngày_triển_khai', 'ngay_trien_khai']),
          performance: getV(item, ['performance', 'hiệu_suất', 'hieu_suat', 'hiệu_quả', 'hieu_qua']),
          metrics: getV(item, ['metrics', 'chỉ_số', 'chi_so', 'metric', 'thước_đo']),
          kpis: getV(item, ['kpis', 'kpi', 'chỉ_số_kpi', 'chi_so_kpi']),
          sla: getV(item, ['sla', 'thỏa_thuận_dịch_vụ', 'thoa_thuan_dich_vu']),
          budget: getV(item, ['budget', 'ngân_sách', 'ngan_sach', 'kinh_phí', 'kinh_phi']),
          cost: getV(item, ['cost', 'chi_phí', 'chi_phi', 'giá_trị', 'gia_tri']),
          roi: getV(item, ['roi', 'lợi_nhuận_đầu_tư', 'loi_nhuan_dau_tu', 'hiệu_quả_đầu_tư']),
          impact: getV(item, ['impact', 'tác_động', 'tac_dong', 'ảnh_hưởng', 'anh_huong']),
          benefits: getV(item, ['benefits', 'lợi_ích', 'loi_ich', 'lợi_thế', 'loi_the']),
          challenges: getV(item, ['challenges', 'thách_thức', 'thach_thuc', 'khó_khăn', 'kho_khan']),
          solutions: getV(item, ['solutions', 'giải_pháp', 'giai_phap', 'cách_giải_quyết']),
          recommendations: getV(item, ['recommendations', 'khuyến_nghị', 'khuyen_nghi', 'đề_xuất', 'de_xuat']),
          
          // Lưu raw data để có thể truy cập đầy đủ
          rawData: item
        });
      });

      // Tính phần trăm cho tất cả nhân viên trong danh sách Form 2
      FORM2_NAMES.forEach(name => {
        const stat = F2_EMPLOYEE_STATS[name];
        if (stat) {
          const total = stat.done;
          if (total > 0) {
            stat.aheadPct = ((stat.ahead / total) * 100).toFixed(1);
            stat.ontimePct = ((stat.ontime / total) * 100).toFixed(1);
            stat.latePct = ((stat.late / total) * 100).toFixed(1);
            stat.naPct = ((stat.na / total) * 100).toFixed(1);
          } else {
            stat.aheadPct = "0";
            stat.ontimePct = "0";
            stat.latePct = "0";
            stat.naPct = "0";
          }
        }
      });
      
      console.log('[Form2 Debug] Final F2_EMPLOYEE_STATS:', F2_EMPLOYEE_STATS);
    }

    // Tính toán tiến độ
    function calculateProgress(requestDate, wishDue, completionDate) {
      if (!requestDate || !wishDue || !completionDate) return 'N/A';
      
      // Hỗ trợ cả 2 định dạng: YYYY-MM-DD HH:mm và YYYY-MM-DD
      let reqDate, wishDate, compDate;
      
      // Parse requestDate
      if (requestDate.includes(' ')) {
        reqDate = new Date(requestDate);
      } else {
        reqDate = new Date(requestDate + ' 00:00:00');
      }
      
      // Parse wishDue
      if (wishDue.includes(' ')) {
        wishDate = new Date(wishDue);
      } else {
        wishDate = new Date(wishDue + ' 00:00:00');
      }
      
      // Parse completionDate
      if (completionDate.includes(' ')) {
        compDate = new Date(completionDate);
      } else {
        compDate = new Date(completionDate + ' 00:00:00');
      }
      
      if (isNaN(reqDate.getTime()) || isNaN(wishDate.getTime()) || isNaN(compDate.getTime())) {
        return 'N/A';
      }
      
      const daysDiff = (compDate.getTime() - wishDate.getTime()) / (1000 * 60 * 60 * 24);
      
      if (daysDiff < 0) return 'Vượt tiến độ';
      if (daysDiff <= 1) return 'Đúng tiến độ';
      return 'Chậm tiến độ';
    }

    // Render bảng thống kê
    function renderForm2Stats() {
      const body = document.getElementById('f2-body-p1');
      if (!body) return;

      // Hiển thị tất cả nhân viên có trong thống kê (bao gồm tên mới xuất hiện trong dữ liệu)
      const allNames = Object.keys(F2_EMPLOYEE_STATS);
      if (allNames.length === 0) {
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="11">Chưa có dữ liệu</td></tr>';
        return;
      }

      // Ưu tiên sắp xếp: tên trong FORM2_NAMES trước, sau đó các tên mới theo alpha
      const preferredSet = new Set(FORM2_NAMES);
      allNames.sort((a,b)=>{
        const aPref = preferredSet.has(a) ? 0 : 1;
        const bPref = preferredSet.has(b) ? 0 : 1;
        if (aPref !== bPref) return aPref - bPref;
        return a.localeCompare(b, 'vi');
      });

      body.innerHTML = '';
      allNames.forEach(name => {
        const stat = F2_EMPLOYEE_STATS[name] || {
          name: name,
          totalTasks: 0,
          done: 0,
          ahead: 0,
          ontime: 0,
          late: 0,
          na: 0,
          aheadPct: "0",
          ontimePct: "0",
          latePct: "0",
          naPct: "0",
          tasks: []
        };
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 font-medium cursor-pointer hover:text-primary-blue" onclick="openF2P1DetailModal('${stat.name}')">${stat.name}</td>
          <td class="px-3 py-2 text-center font-semibold text-blue-600">${stat.totalTasks}</td>
          <td class="px-3 py-2 text-center">${stat.done}</td>
          <td class="px-3 py-2 text-center text-green-600">${stat.ahead}</td>
          <td class="px-3 py-2 text-center text-blue-600">${stat.ontime}</td>
          <td class="px-3 py-2 text-center text-red-600">${stat.late}</td>
          <td class="px-3 py-2 text-center text-gray-600">${stat.na}</td>
          <td class="px-3 py-2 text-center text-green-600">${stat.aheadPct || 0}%</td>
          <td class="px-3 py-2 text-center text-blue-600">${stat.ontimePct || 0}%</td>
          <td class="px-3 py-2 text-center text-red-600">${stat.latePct || 0}%</td>
          <td class="px-3 py-2 text-center text-gray-600">${stat.naPct || 0}%</td>
        `;
        body.appendChild(tr);
      });
    }

    // Form 2: Render panel data (legacy function - now calls fetchForm2Data)
    function renderForm2Panel(panelId) {
      if (panelId === 'p1') {
        fetchForm2Data();
      }
    }

    // Form 2: Search button event listeners
    document.querySelectorAll('[id^="f2-search-"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const panelId = btn.id.replace('f2-search-', '');
        
        // Show loading state
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = "<span class='spinner mr-2'></span>Đang tải...";
        
        // Simulate API call
        setTimeout(() => {
          renderForm2Panel(panelId);
          btn.disabled = false;
          btn.textContent = originalText;
          showToast(`Đã tải dữ liệu ${panelId.toUpperCase()}.`, 'success');
        }, 1000);
      });
    });

    // Form 2: Export functionality
    const f2ExportBtn = document.getElementById('f2-export');
    const f2ExportXlsxBtn = document.getElementById('f2-export-xlsx');
    
    if (f2ExportBtn) {
      f2ExportBtn.addEventListener('click', (e) => {
        e.preventDefault();
        showToast('Chức năng xuất server đang được phát triển.', 'info');
      });
    }
    
    if (f2ExportXlsxBtn) {
      f2ExportXlsxBtn.addEventListener('click', (e) => {
        e.preventDefault();
        showToast('Chức năng xuất XLSX đang được phát triển.', 'info');
      });
    }

    // Form 2: Modal functions
    function openF2P1DetailModal(employeeName) {
      const modal = document.getElementById('f2-p1-detail-modal');
      const nameSpan = document.getElementById('f2-p1-detail-name');
      const body = document.getElementById('f2-p1-detail-body');
      
      if (nameSpan) nameSpan.textContent = employeeName;
      
      // Lấy dữ liệu thực từ F2_EMPLOYEE_STATS
      const employeeData = F2_EMPLOYEE_STATS[employeeName];
      
      if (!employeeData || !employeeData.tasks || employeeData.tasks.length === 0) {
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Không có dữ liệu tác vụ</td></tr>';
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        return;
      }
      
      // Lọc: chỉ hiển thị các tác vụ được đếm
      // - Luôn gồm các tác vụ Doing (được tính vào totalTasks)
      // - Và các tác vụ Done có completionDate nằm trong F2_MONTH_FILTER (nếu đang lọc tháng)
      // - Nếu không lọc tháng, hiển thị Doing và tất cả Done có completionDate
      const filtered = (employeeData.tasks || []).filter(task => {
        const statusLower = String(task.status || '').toLowerCase();
        const isDoing = statusLower.includes('doing') || statusLower.includes('đang');
        const isDone = statusLower.includes('hoàn') || statusLower.includes('done');
        const isCancelled = statusLower.includes('cancel') || statusLower.includes('hủy') || statusLower.includes('huỷ');
        if (isCancelled) return false;
        if (isDoing) return true;
        if (!isDone) return false;
        const comp = task.completionDate;
        if (!comp) return false;
        const compDate = parseDateFlexible(comp);
        if (isNaN(compDate.getTime())) return false;
        if (F2_MONTH_FILTER) {
          const ym = `${compDate.getFullYear()}-${String(compDate.getMonth()+1).padStart(2,'0')}`;
          return ym === F2_MONTH_FILTER;
        }
        return true;
      });

      // Sắp xếp: Doing trên, Done phía dưới (giữ nguyên thứ tự bên trong mỗi nhóm)
      const sorted = filtered.sort((a,b)=>{
        const aStatus = String(a.status||'').toLowerCase();
        const bStatus = String(b.status||'').toLowerCase();
        const aDoing = aStatus.includes('doing') || aStatus.includes('đang');
        const bDoing = bStatus.includes('doing') || bStatus.includes('đang');
        if (aDoing && !bDoing) return -1;
        if (!aDoing && bDoing) return 1;
        return 0;
      });

      body.innerHTML = '';
      sorted.forEach((task) => {
        const tr = document.createElement('tr');
        
        // Tạo badge trạng thái
        const statusLower = (task.status || '').toLowerCase();
        const isDone = statusLower.includes('hoàn') || statusLower.includes('done');
        const isCancelled = statusLower.includes('cancel') || statusLower.includes('hủy') || statusLower.includes('huỷ');
        const statusBadge = `<span class="px-2 py-1 rounded text-xs ${isDone ? 'bg-green-100 text-green-800' : (isCancelled || statusLower.includes('chờ') || statusLower.includes('pending')) ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">${task.status || ''}</span>`;
        
        tr.innerHTML = `
          <td class="px-3 py-2">${statusBadge}</td>
          <td class="px-3 py-2">${task.completionDate || '-'}</td>
          <td class="px-3 py-2">${task.code || '-'}</td>
          <td class="px-3 py-2">${task.taskName || '-'}</td>
          <td class="px-3 py-2">${task.requester || '-'}</td>
          <td class="px-3 py-2">${task.requestDate || '-'}</td>
          <td class="px-3 py-2">${task.wishDue || '-'}</td>
          <td class="px-3 py-2">${task.note || '-'}</td>
        `;
        body.appendChild(tr);
      });
      
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeF2P1DetailModal() {
      const modal = document.getElementById('f2-p1-detail-modal');
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
    }

    // Form 2: Modal event listeners
    const f2P1DetailCloseBtn = document.getElementById('f2-p1-detail-close');
    if (f2P1DetailCloseBtn) {
      f2P1DetailCloseBtn.addEventListener('click', closeF2P1DetailModal);
    }

    const f2P1DetailModal = document.getElementById('f2-p1-detail-modal');
    if (f2P1DetailModal) {
      f2P1DetailModal.addEventListener('click', (e) => {
        if (e.target === f2P1DetailModal) closeF2P1DetailModal();
      });
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && f2P1DetailModal.classList.contains('open')) {
        closeF2P1DetailModal();
      }
    });

    // Initialize Form 2 with P1
    setTimeout(() => {
      fetchForm2Data();
    }, 100);

    // Helper function: escapeHtml
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Helper function: openModal và closeModal (nếu chưa có)
    function openModal(modalId, callback) {
      const modal = document.getElementById(`modal-${modalId}`);
      if (!modal) return false;
      modal.classList.remove('hidden');
      modal.style.display = 'flex';
      if (callback) callback(modal, {});
      return true;
    }

    function closeModal(modalId) {
      const modal = document.getElementById(`modal-${modalId}`);
      if (!modal) return;
      modal.classList.add('hidden');
      modal.style.display = 'none';
    }

    function initModalListeners(modalId) {
      const modal = document.getElementById(`modal-${modalId}`);
      if (!modal) return;
      const closeBtn = modal.querySelector(`[id*="close"]`);
      if (closeBtn) {
        closeBtn.addEventListener('click', () => closeModal(modalId));
      }
      modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target.classList.contains('modal-overlay')) {
          closeModal(modalId);
        }
      });
    }

    // ===== FORM 3 - QUẢN LÝ DỰ ÁN =====
    let F3_EXCEL_FILE = null;
    let F3_ALL_DATA = [];
    let F3_FILTERED_DATA = [];
    let F3_EXPANDED_EPICS = new Set();
    let F3_EXPANDED_STORIES = new Set();
    let F3_CURRENT_SUBTASK_ID = null; // Lưu ID subtask đang được chỉnh sửa
    const F3_WEBHOOK_URL = 'https://iatzhxxuk.tino.page/webhook/f3_KBNCTN2';
    const F3_DECLARATION_WEBHOOK_URL = 'https://iatzhxxuk.tino.page/webhook/f3KhaibaosubtaskNCTN2';

    function formatF3Date(dateString) {
      if (!dateString) return '-';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return dateString;
      }
    }

    function formatFileSize(bytes) {
      if (!bytes) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function getF3StatusBadge(status) {
      if (!status) return '<span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700">-</span>';
      const statusStr = String(status).trim();
      const statusLower = statusStr.toLowerCase();
      if (statusLower === 'hoàn thành đúng hạn' || statusLower.includes('hoàn thành')) {
        return '<span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700">Hoàn thành</span>';
      } else if (statusLower === 'đang triển khai' || statusLower.includes('đang triển khai')) {
        return '<span class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700">Đang triển khai</span>';
      } else if (statusLower === 'chưa triển khai' || statusLower.includes('chưa triển khai')) {
        return '<span class="px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-700">Chưa triển khai</span>';
      } else if (statusLower.includes('hủy') || statusLower.includes('cancel') || statusLower.includes('cancelled')) {
        return '<span class="px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700">Đã hủy</span>';
      }
      return `<span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700">${escapeHtml(statusStr)}</span>`;
    }

    // Xử lý dữ liệu từ API thành cấu trúc phân cấp Epic → Story → Subtask
    function organizeF3Data(flatData) {
      const epicsMap = new Map();
      
      flatData.forEach(item => {
        // Lấy các trường dữ liệu với nhiều biến thể tên
        const getValue = (keys) => {
          for (const key of keys) {
            if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
              return item[key];
            }
          }
          return null;
        };

        // Đọc tên với ưu tiên từ server format
        const epicName = getValue(['epic', 'Epic', 'EPIC', 'Tên Epic', 'tên epic']);
        const storyName = getValue(['story', 'Story', 'STORY', 'Tên Story', 'tên story']);
        const subtaskName = getValue(['subtask', 'Subtask', 'SUBTASK', 'Tên Subtask', 'tên subtask', 'Task', 'task']);
        
        // Đọc level từ server
        const level = getValue(['level', 'Level', 'LEVEL', 'Cấp', 'cấp']) || 
                     (epicName && !storyName && !subtaskName ? 'epic' :
                      storyName && !subtaskName ? 'story' : 'subtask');

        // Xác định Epic
        let epicKey = epicName || 'Epic không tên';
        if (!epicsMap.has(epicKey)) {
          epicsMap.set(epicKey, {
            id: epicKey,
            name: epicName || 'Epic không tên',
            type: 'epic',
            assignee: getValue(['assignee', 'Người thực hiện', 'Assignee', 'người thực hiện']),
            status: getValue(['status', 'Trạng thái', 'Status', 'trạng thái']),
            startDate: getValue(['start_date', 'startDate', 'Ngày bắt đầu', 'Start Date', 'ngày bắt đầu']),
            dueDate: getValue(['due_date', 'dueDate', 'Hạn HT', 'Due Date', 'hạn hoàn thành']),
            completedDate: getValue(['finish_date', 'completedDate', 'completed_date', 'Ngày hoàn thành', 'Completed Date', 'ngày hoàn thành']),
            jiraKey: getValue(['jira_key', 'Mã Jira/KOI', 'Jira Key', 'jiraKey', 'mã jira', 'Jira']),
            jiraLink: getValue(['jira_link', 'jiraLink', 'Link jira', 'link jira']),
            taskCode: getValue(['task_code', 'taskCode', 'Task Code', 'task code']),
            note: getValue(['note', 'Ghi chú', 'Note', 'ghi chú']),
            stories: new Map()
          });
        }
        const epic = epicsMap.get(epicKey);

        // Xác định Story
        if (storyName || level === 'story') {
          const storyKey = `${epicKey}::${storyName || 'Story không tên'}`;
          if (!epic.stories.has(storyKey)) {
            epic.stories.set(storyKey, {
              id: storyKey,
              name: storyName || 'Story không tên',
              type: 'story',
              epicId: epicKey,
              assignee: getValue(['assignee', 'Người thực hiện', 'Assignee', 'người thực hiện']),
              status: getValue(['status', 'Trạng thái', 'Status', 'trạng thái']),
              startDate: getValue(['start_date', 'startDate', 'Ngày bắt đầu', 'Start Date', 'ngày bắt đầu']),
              dueDate: getValue(['due_date', 'dueDate', 'Hạn HT', 'Due Date', 'hạn hoàn thành']),
              completedDate: getValue(['finish_date', 'completedDate', 'completed_date', 'Ngày hoàn thành', 'Completed Date', 'ngày hoàn thành']),
              jiraKey: getValue(['jira_key', 'Mã Jira/KOI', 'Jira Key', 'jiraKey', 'mã jira', 'Jira']),
              jiraLink: getValue(['jira_link', 'jiraLink', 'Link jira', 'link jira']),
              taskCode: getValue(['task_code', 'taskCode', 'Task Code', 'task code']),
              note: getValue(['note', 'Ghi chú', 'Note', 'ghi chú']),
              subtasks: []
            });
          }
          const story = epic.stories.get(storyKey);

          // Xác định Subtask
          if (subtaskName || level === 'subtask') {
            story.subtasks.push({
              id: `${storyKey}::${subtaskName || 'Subtask không tên'}`,
              serverId: getValue(['Id', 'id', 'ID']), // Lưu Id từ server
              name: subtaskName || 'Subtask không tên',
              type: 'subtask',
              epicId: epicKey,
              storyId: storyKey,
              assignee: getValue(['assignee', 'Người thực hiện', 'Assignee', 'người thực hiện']),
              status: getValue(['status', 'Trạng thái', 'Status', 'trạng thái']),
              startDate: getValue(['start_date', 'startDate', 'Ngày bắt đầu', 'Start Date', 'ngày bắt đầu']),
              dueDate: getValue(['due_date', 'dueDate', 'Hạn HT', 'Due Date', 'hạn hoàn thành']),
              completedDate: getValue(['finish_date', 'completedDate', 'completed_date', 'Ngày hoàn thành', 'Completed Date', 'ngày hoàn thành']),
              jiraKey: getValue(['jira_key', 'Mã Jira/KOI', 'Jira Key', 'jiraKey', 'mã jira', 'Jira']),
              jiraLink: getValue(['jira_link', 'jiraLink', 'Link jira', 'link jira']),
              taskCode: getValue(['task_code', 'taskCode', 'Task Code', 'task code']),
              note: getValue(['note', 'Ghi chú', 'Note', 'ghi chú']),
              isCanceled: getValue(['is_canceled', 'isCanceled', 'Is Canceled', 'is_canceled']) === 'true' || getValue(['is_canceled', 'isCanceled', 'Is Canceled', 'is_canceled']) === true
            });
          }
        }
      });

      // Chuyển Map thành Array
      const epics = Array.from(epicsMap.values()).map(epic => ({
        ...epic,
        stories: Array.from(epic.stories.values())
      }));

      return { epics };
    }

    // Render một hàng trong bảng
    function renderF3Row(item, level = 0, isExpanded = false, hasChildren = false) {
      const indent = level * 24;
      const isEpic = item.type === 'epic';
      const isStory = item.type === 'story';
      const isSubtask = item.type === 'subtask';
      
      const expandIcon = hasChildren 
        ? (isExpanded 
          ? '<span class="material-icons text-sm text-gray-600 cursor-pointer">expand_more</span>'
          : '<span class="material-icons text-sm text-gray-600 cursor-pointer">chevron_right</span>')
        : '<span class="w-4"></span>';

      const rowClass = isEpic ? 'bg-blue-50 font-semibold' : isStory ? 'bg-purple-50' : 'bg-white';
      const nameClass = isEpic ? 'text-blue-700' : isStory ? 'text-purple-700' : 'text-gray-900';

      let actionButton = '-';
      if (isSubtask) {
        actionButton = `<button class="f3-edit-btn px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors" data-id="${item.id}">Thay đổi</button>`;
      } else if (isStory) {
        actionButton = `<button class="f3-add-subtask-btn px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors" data-id="${item.id}" data-epic-id="${item.epicId}">Thêm Subtask</button>`;
      } else if (isEpic) {
        actionButton = `<button class="f3-add-story-btn px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-colors" data-id="${item.id}">Thêm Story</button>`;
      }

      return `
        <div class="grid grid-cols-12 gap-4 px-6 py-3 ${rowClass} hover:bg-opacity-80 transition-colors border-b border-[#f1f0f4]" data-id="${item.id}" data-type="${item.type}" data-level="${level}">
          <div class="col-span-3 flex items-center gap-2" style="padding-left: ${indent}px;">
            ${expandIcon}
            <span class="${nameClass} text-sm">${escapeHtml(item.name || '-')}</span>
          </div>
          <div class="col-span-1 flex items-center">
            ${actionButton}
          </div>
          <div class="col-span-2 flex items-center text-sm text-gray-700">${escapeHtml(item.assignee || '-')}</div>
          <div class="col-span-1 flex items-center">${getF3StatusBadge(item.status)}</div>
          <div class="col-span-1 flex items-center text-sm text-gray-600">${formatF3Date(item.startDate)}</div>
          <div class="col-span-1 flex items-center text-sm text-gray-600">${formatF3Date(item.dueDate)}</div>
          <div class="col-span-1 flex items-center text-sm text-gray-600">${formatF3Date(item.completedDate)}</div>
          <div class="col-span-1 flex items-center text-sm text-gray-700">
            ${item.jiraKey && item.jiraKey !== '' 
              ? `<a href="${escapeHtml(item.jiraLink || '#')}" target="_blank" class="text-xs font-medium text-primary-blue hover:underline">${escapeHtml(item.jiraKey)}</a>` 
              : '-'}
          </div>
          <div class="col-span-1 flex items-center text-sm text-gray-600">${escapeHtml((item.note || '').substring(0, 30))}${(item.note || '').length > 30 ? '...' : ''}</div>
        </div>
      `;
    }

    // Render toàn bộ bảng
    function renderF3Table() {
      const tbody = document.getElementById('f3-table-body');
      if (!tbody) return;

      if (!F3_FILTERED_DATA || !F3_FILTERED_DATA.epics || F3_FILTERED_DATA.epics.length === 0) {
        tbody.innerHTML = `
          <div class="px-6 py-8 text-center text-[#6b6189]">
            <div class="flex flex-col items-center gap-2">
              <span class="material-icons text-4xl text-gray-300">table_chart</span>
              <p>Chưa có dữ liệu. Vui lòng tải dữ liệu hoặc upload file Excel.</p>
            </div>
          </div>
        `;
        return;
      }

      let html = '';
      F3_FILTERED_DATA.epics.forEach(epic => {
        const epicExpanded = F3_EXPANDED_EPICS.has(epic.id);
        html += renderF3Row(epic, 0, epicExpanded, epic.stories && epic.stories.length > 0);
        
        if (epicExpanded && epic.stories) {
          epic.stories.forEach(story => {
            const storyExpanded = F3_EXPANDED_STORIES.has(story.id);
            html += renderF3Row(story, 1, storyExpanded, story.subtasks && story.subtasks.length > 0);
            
            if (storyExpanded && story.subtasks) {
              story.subtasks.forEach(subtask => {
                html += renderF3Row(subtask, 2, false, false);
              });
            }
          });
        }
      });

      tbody.innerHTML = html;

      // Thêm event listeners cho expand/collapse
      tbody.querySelectorAll('[data-type="epic"]').forEach(row => {
        const expandIcon = row.querySelector('.material-icons');
        if (expandIcon) {
          expandIcon.addEventListener('click', () => {
            const epicId = row.getAttribute('data-id');
            if (F3_EXPANDED_EPICS.has(epicId)) {
              F3_EXPANDED_EPICS.delete(epicId);
            } else {
              F3_EXPANDED_EPICS.add(epicId);
            }
            renderF3Table();
          });
        }
      });

      tbody.querySelectorAll('[data-type="story"]').forEach(row => {
        const expandIcon = row.querySelector('.material-icons');
        if (expandIcon) {
          expandIcon.addEventListener('click', () => {
            const storyId = row.getAttribute('data-id');
            if (F3_EXPANDED_STORIES.has(storyId)) {
              F3_EXPANDED_STORIES.delete(storyId);
            } else {
              F3_EXPANDED_STORIES.add(storyId);
            }
            renderF3Table();
          });
        }
      });

      // Thêm event listeners cho nút "Thay đổi"
      tbody.querySelectorAll('.f3-edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const itemId = btn.getAttribute('data-id');
          openF3DeclarationModal(itemId);
        });
      });

      // Thêm event listeners cho nút "Thêm Story"
      tbody.querySelectorAll('.f3-add-story-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const epicId = btn.getAttribute('data-id');
          openF3AddStoryModal(epicId);
        });
      });

      // Thêm event listeners cho nút "Thêm Subtask"
      tbody.querySelectorAll('.f3-add-subtask-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const storyId = btn.getAttribute('data-id');
          const epicId = btn.getAttribute('data-epic-id');
          openF3AddSubtaskModal(epicId, storyId);
        });
      });
    }

    // Mở modal thêm Story
    function openF3AddStoryModal(epicId) {
      const result = findF3ItemById(epicId);
      if (!result || result.type !== 'epic') {
        showToast('Không tìm thấy Epic', 'error');
        return;
      }

      const epic = result.item;
      const modal = document.getElementById('modal-f3-add-story');
      
      if (modal) {
        document.getElementById('modal-f3-add-story-epic-id').value = epicId;
        document.getElementById('modal-f3-add-story-epic-name').textContent = epic.name || '';
        
        // Tự động sinh Story Code (có thể tùy chỉnh logic này)
        const storyCode = `STORY-${Date.now().toString().slice(-6)}`;
        document.getElementById('modal-f3-add-story-code').value = storyCode;
        
        // Reset các trường khác
        document.getElementById('modal-f3-add-story-name').value = '';
        document.getElementById('modal-f3-add-story-assignee').value = '';
        document.getElementById('modal-f3-add-story-start-date').value = '';
        document.getElementById('modal-f3-add-story-due-date').value = '';
        document.getElementById('modal-f3-add-story-jira-key').value = '';
        document.getElementById('modal-f3-add-story-jira-link').value = '';
        document.getElementById('modal-f3-add-story-note').value = '';
        
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
      }
    }

    // Mở modal thêm Subtask
    function openF3AddSubtaskModal(epicId, storyId) {
      const epicResult = findF3ItemById(epicId);
      const storyResult = findF3ItemById(storyId);
      
      if (!epicResult || epicResult.type !== 'epic') {
        showToast('Không tìm thấy Epic', 'error');
        return;
      }
      
      if (!storyResult || storyResult.type !== 'story') {
        showToast('Không tìm thấy Story', 'error');
        return;
      }

      const epic = epicResult.item;
      const story = storyResult.item;
      const modal = document.getElementById('modal-f3-add-subtask');
      
      if (modal) {
        document.getElementById('modal-f3-add-subtask-epic-id').value = epicId;
        document.getElementById('modal-f3-add-subtask-epic-name').textContent = epic.name || '';
        document.getElementById('modal-f3-add-subtask-story-id').value = storyId;
        document.getElementById('modal-f3-add-subtask-story-name').textContent = story.name || '';
        
        // Tự động sinh Task Code (có thể tùy chỉnh logic này)
        const taskCode = `TASK-${Date.now().toString().slice(-6)}`;
        document.getElementById('modal-f3-add-subtask-task-code').value = taskCode;
        
        // Reset các trường khác
        document.getElementById('modal-f3-add-subtask-name').value = '';
        document.getElementById('modal-f3-add-subtask-assignee').value = '';
        document.getElementById('modal-f3-add-subtask-start-date').value = '';
        document.getElementById('modal-f3-add-subtask-due-date').value = '';
        document.getElementById('modal-f3-add-subtask-jira-key').value = '';
        document.getElementById('modal-f3-add-subtask-jira-link').value = '';
        document.getElementById('modal-f3-add-subtask-note').value = '';
        
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
      }
    }

    // Tìm item theo ID trong cấu trúc dữ liệu
    function findF3ItemById(itemId) {
      for (const epic of F3_ALL_DATA.epics || []) {
        if (epic.id === itemId) return { item: epic, type: 'epic' };
        for (const story of epic.stories || []) {
          if (story.id === itemId) return { item: story, type: 'story' };
          for (const subtask of story.subtasks || []) {
            if (subtask.id === itemId) return { item: subtask, type: 'subtask', epic, story };
          }
        }
      }
      return null;
    }

    // Mở modal cập nhật thông tin
    function openF3DeclarationModal(itemId) {
      const result = findF3ItemById(itemId);
      if (!result) {
        showToast('Không tìm thấy tác vụ', 'error');
        return;
      }

      const { item, type, epic, story } = result;
      
      // Chỉ cho phép cập nhật Subtask
      if (type !== 'subtask') {
        showToast('Chỉ có thể cập nhật thông tin cho Subtask', 'info');
        return;
      }

      const modal = document.getElementById('modal-f3-declaration');
      
      if (modal) {
        F3_CURRENT_SUBTASK_ID = itemId;
        document.getElementById('modal-f3-declaration-epic').value = epic ? epic.name : '';
        document.getElementById('modal-f3-declaration-story').value = story ? story.name : '';
        document.getElementById('modal-f3-declaration-subtask').value = item.name || '';
        document.getElementById('modal-f3-declaration-status').value = item.status || '';
        document.getElementById('modal-f3-declaration-jira-key').value = item.jiraKey || '';
        document.getElementById('modal-f3-declaration-jira-link').value = item.jiraLink || '';
        document.getElementById('modal-f3-declaration-note').value = item.note || '';
        
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
      }
    }

    // POST: Cập nhật thông tin Subtask (Khai báo)
    async function updateF3Subtask(subtaskId, data) {
      try {
        // Đảm bảo không có subtask_id trong data, chỉ có Id
        const cleanData = { ...data };
        delete cleanData.subtask_id; // Xóa subtask_id nếu có
        
        console.log('[Form 3] Sending to webhook:', F3_DECLARATION_WEBHOOK_URL);
        console.log('[Form 3] Payload:', cleanData);
        
        const response = await fetch(F3_DECLARATION_WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(cleanData)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        return result;
      } catch (error) {
        console.error('[Form 3] Error updating subtask:', error);
        throw error;
      }
    }

    // POST: Tạo Story mới
    async function createF3Story(data) {
      try {
        const response = await fetch(F3_WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            action: 'create_story',
            ...data
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        return result;
      } catch (error) {
        console.error('[Form 3] Error creating story:', error);
        throw error;
      }
    }

    // POST: Tạo Subtask mới
    async function createF3Subtask(data) {
      try {
        const response = await fetch(F3_WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            action: 'create_subtask',
            ...data
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        return result;
      } catch (error) {
        console.error('[Form 3] Error creating subtask:', error);
        throw error;
      }
    }

    // Lọc dữ liệu
    function filterF3Data() {
      const searchTerm = (document.getElementById('f3-search-input')?.value || '').toLowerCase();
      const statusFilter = document.getElementById('f3-filter-status')?.value || '';
      const assigneeFilter = document.getElementById('f3-filter-assignee')?.value || '';
      const levelFilter = document.getElementById('f3-filter-level')?.value || 'all';

      // Kiểm tra item có match với filter không (không bao gồm level filter)
      const matchesFilters = (item) => {
        // Kiểm tra search term
        if (searchTerm) {
          const searchFields = [
            item.name || '',
            item.assignee || '',
            item.jiraKey || '',
            item.note || ''
          ].join(' ').toLowerCase();
          if (!searchFields.includes(searchTerm)) {
            return false;
          }
        }

        // Kiểm tra status filter
        if (statusFilter) {
          if (!item.status || !item.status.toLowerCase().includes(statusFilter.toLowerCase())) {
            return false;
          }
        }

        // Kiểm tra assignee filter
        if (assigneeFilter) {
          if (item.assignee !== assigneeFilter) {
            return false;
          }
        }

        return true;
      };

      // Kiểm tra level filter
      const matchesLevel = (item) => {
        if (levelFilter === 'all') return true;
        if (levelFilter === 'epic') return item.type === 'epic';
        if (levelFilter === 'story') return item.type === 'story';
        if (levelFilter === 'subtask') return item.type === 'subtask';
        return true;
      };

      // Filter subtask - phải match tất cả filters bao gồm level
      const filterSubtask = (subtask) => {
        return matchesFilters(subtask) && matchesLevel(subtask);
      };

      // Filter story - hiển thị nếu story match HOẶC có subtask match
      const filterStory = (story) => {
        // Nếu level filter là "epic", không hiển thị story
        if (levelFilter === 'epic') return false;
        
        // Nếu level filter là "story", chỉ kiểm tra story có match không
        if (levelFilter === 'story') {
          return matchesFilters(story) && matchesLevel(story);
        }
        
        // Nếu level filter là "subtask", chỉ hiển thị story nếu có subtask match
        if (levelFilter === 'subtask') {
          // Story phải có ít nhất một subtask match
          return (story.subtasks || []).some(filterSubtask);
        }
        
        // Level filter là "all" - hiển thị story nếu story match HOẶC có subtask match
        const storyMatches = matchesFilters(story);
        const hasMatchingSubtasks = (story.subtasks || []).some(filterSubtask);
        return storyMatches || hasMatchingSubtasks;
      };

      // Filter epic - hiển thị nếu epic match HOẶC có story/subtask match
      const filterEpic = (epic) => {
        // Nếu level filter là "epic", chỉ kiểm tra epic có match không
        if (levelFilter === 'epic') {
          return matchesFilters(epic) && matchesLevel(epic);
        }
        
        // Nếu level filter là "story" hoặc "subtask", chỉ hiển thị epic nếu có children match
        if (levelFilter === 'story' || levelFilter === 'subtask') {
          return (epic.stories || []).some(filterStory);
        }
        
        // Level filter là "all" - hiển thị epic nếu epic match HOẶC có story/subtask match
        const epicMatches = matchesFilters(epic);
        const hasMatchingChildren = (epic.stories || []).some(filterStory);
        return epicMatches || hasMatchingChildren;
      };

      // Áp dụng filter từ dưới lên (subtask -> story -> epic)
      // Đảm bảo chỉ giữ lại các subtask match, sau đó filter story, cuối cùng filter epic
      const filteredEpics = (F3_ALL_DATA.epics || []).map(epic => {
        // Filter stories và subtasks của chúng
        const filteredStories = (epic.stories || []).map(story => {
          // Luôn filter subtasks trước
          const filteredSubtasks = (story.subtasks || []).filter(filterSubtask);
          // Trả về story với subtasks đã được filter
          return { ...story, subtasks: filteredSubtasks };
        }).filter(filterStory); // Sau đó filter stories

        // Trả về epic với stories đã được filter
        return { ...epic, stories: filteredStories };
      }).filter(filterEpic); // Cuối cùng filter epics

      F3_FILTERED_DATA = { epics: filteredEpics };
      
      // Render lại bảng với dữ liệu đã filter
      renderF3Table();
    }

    // Cập nhật danh sách assignee trong filter
    function updateF3AssigneeFilter() {
      const assigneeSelect = document.getElementById('f3-filter-assignee');
      if (!assigneeSelect) return;

      const assignees = new Set();
      (F3_ALL_DATA.epics || []).forEach(epic => {
        if (epic.assignee) assignees.add(epic.assignee);
        (epic.stories || []).forEach(story => {
          if (story.assignee) assignees.add(story.assignee);
          (story.subtasks || []).forEach(subtask => {
            if (subtask.assignee) assignees.add(subtask.assignee);
          });
        });
      });

      const currentValue = assigneeSelect.value;
      assigneeSelect.innerHTML = '<option value="">Tất cả thành viên</option>';
      Array.from(assignees).sort().forEach(assignee => {
        const option = document.createElement('option');
        option.value = assignee;
        option.textContent = assignee;
        assigneeSelect.appendChild(option);
      });
      assigneeSelect.value = currentValue;
    }

    async function loadF3Data() {
      const loadingDiv = document.getElementById('f3-loading');
      const loadBtn = document.getElementById('f3-load-data-btn');
      const tbody = document.getElementById('f3-table-body');
      const webhookUrl = F3_WEBHOOK_URL;
      try {
        if (loadingDiv) loadingDiv.classList.remove('hidden');
        if (loadBtn) loadBtn.disabled = true;
        if (tbody) tbody.innerHTML = '<div class="px-6 py-8 text-center text-gray-500">Đang tải dữ liệu...</div>';
        
        const response = await fetch(webhookUrl, { method: 'GET', headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' } });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const responseText = await response.text();
        let data = JSON.parse(responseText);
        let flatData = [];
        if (Array.isArray(data)) flatData = data;
        else if (data && Array.isArray(data.data)) flatData = data.data;
        else if (data && Array.isArray(data.results)) flatData = data.results;
        else if (data && Array.isArray(data.items)) flatData = data.items;
        else if (data && typeof data === 'object') flatData = [data];
        
        // Tổ chức dữ liệu thành cấu trúc phân cấp
        F3_ALL_DATA = organizeF3Data(flatData);
        F3_FILTERED_DATA = F3_ALL_DATA;
        
        // Tự động mở tất cả Epic và Story
        F3_EXPANDED_EPICS.clear();
        F3_EXPANDED_STORIES.clear();
        (F3_ALL_DATA.epics || []).forEach(epic => {
          F3_EXPANDED_EPICS.add(epic.id);
          (epic.stories || []).forEach(story => {
            F3_EXPANDED_STORIES.add(story.id);
          });
        });
        
        // Cập nhật filter assignee
        updateF3AssigneeFilter();
        
        // Render bảng
        renderF3Table();
        
        // Cập nhật dashboard Form 6 nếu đang hiển thị
        const form6 = document.getElementById('form6');
        if (form6 && typeof updateF6Dashboard === 'function' && !form6.classList.contains('hidden')) {
          updateF6Dashboard();
        }
        
        showToast(`Đã tải ${flatData.length} bản ghi`, 'success');
      } catch (error) {
        console.error('[Form 3] Error loading data:', error);
        if (tbody) tbody.innerHTML = `<div class="px-6 py-8 text-center text-red-500">Lỗi: ${escapeHtml(error.message)}</div>`;
        showToast('Lỗi khi tải dữ liệu: ' + error.message, 'error');
      } finally {
        if (loadingDiv) loadingDiv.classList.add('hidden');
        if (loadBtn) loadBtn.disabled = false;
      }
    }

    function exportF3ToExcel() {
      showToast('Chức năng xuất Excel đang được phát triển. Vui lòng cài đặt thư viện SheetJS (XLSX).', 'info');
    }

    // Hàm đóng modal declaration
    function closeF3DeclarationModal() {
      const modalF3Declaration = document.getElementById('modal-f3-declaration');
      if (modalF3Declaration) {
        modalF3Declaration.classList.add('hidden');
        modalF3Declaration.style.display = 'none';
        F3_CURRENT_SUBTASK_ID = null;
      }
    }

    // Khởi tạo Form 3 Event Listeners
    function initF3EventListeners() {
      // Form 3 Event Listeners
      const f3LoadBtn = document.getElementById('f3-load-data-btn');
      const f3ExportBtn = document.getElementById('f3-export-btn');
      const f3SearchInput = document.getElementById('f3-search-input');
      const f3FilterStatus = document.getElementById('f3-filter-status');
      const f3FilterAssignee = document.getElementById('f3-filter-assignee');
      const f3FilterLevel = document.getElementById('f3-filter-level');
      
      if (f3LoadBtn) f3LoadBtn.addEventListener('click', loadF3Data);
      if (f3ExportBtn) f3ExportBtn.addEventListener('click', exportF3ToExcel);
      
      // Debounce cho search input để tránh filter quá nhiều lần
      let searchTimeout = null;
      if (f3SearchInput) {
        f3SearchInput.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            filterF3Data();
          }, 300); // Đợi 300ms sau khi người dùng ngừng gõ
        });
        
        // Cho phép Enter để filter ngay lập tức
        f3SearchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            clearTimeout(searchTimeout);
            filterF3Data();
          }
        });
      }
      
      // Các filter khác áp dụng ngay lập tức
      if (f3FilterStatus) {
        f3FilterStatus.addEventListener('change', () => {
          filterF3Data();
        });
      }
      if (f3FilterAssignee) {
        f3FilterAssignee.addEventListener('change', () => {
          filterF3Data();
        });
      }
      if (f3FilterLevel) {
        f3FilterLevel.addEventListener('change', () => {
          filterF3Data();
        });
      }

      // Modal Declaration event listeners
      const modalF3Declaration = document.getElementById('modal-f3-declaration');
      const modalF3DeclarationClose = document.getElementById('modal-f3-declaration-close');
      const modalF3DeclarationCancel = document.getElementById('modal-f3-declaration-cancel');
      const modalF3DeclarationSubmit = document.getElementById('modal-f3-declaration-submit');
      const modalF3DeclarationOverlay = document.getElementById('modal-f3-declaration-overlay');
      const modalF3DeclarationContent = document.getElementById('modal-f3-declaration-content');
      
      // Ngăn click vào content đóng modal
      if (modalF3DeclarationContent) {
        modalF3DeclarationContent.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }
      
      if (modalF3DeclarationClose) {
        modalF3DeclarationClose.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeF3DeclarationModal();
        });
      }
      
      if (modalF3DeclarationCancel) {
        modalF3DeclarationCancel.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeF3DeclarationModal();
        });
      }
      
      if (modalF3DeclarationSubmit) {
        modalF3DeclarationSubmit.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          if (!F3_CURRENT_SUBTASK_ID) {
            showToast('Không tìm thấy Subtask cần cập nhật', 'error');
            return;
          }

          const status = document.getElementById('modal-f3-declaration-status')?.value;
          const jiraKey = document.getElementById('modal-f3-declaration-jira-key')?.value;
          const jiraLink = document.getElementById('modal-f3-declaration-jira-link')?.value;
          const note = document.getElementById('modal-f3-declaration-note')?.value;

          if (!status || !jiraKey) {
            showToast('Vui lòng điền đầy đủ thông tin bắt buộc (Trạng thái, Mã Jira)', 'error');
            return;
          }

          try {
            modalF3DeclarationSubmit.disabled = true;
            const originalText = modalF3DeclarationSubmit.textContent;
            modalF3DeclarationSubmit.textContent = 'Đang lưu...';

            const result = findF3ItemById(F3_CURRENT_SUBTASK_ID);
            if (!result) {
              throw new Error('Không tìm thấy Subtask');
            }

            const { item, epic, story } = result;
            
            // Tạo timestamp dạng YYYY-MM-DD HH:mm (GMT+7)
            const now = new Date();
            // Chuyển sang GMT+7: lấy UTC time và cộng thêm 7 giờ
            const utcTime = now.getTime() + (now.getTimezoneOffset() * 60 * 1000);
            const gmt7Time = new Date(utcTime + (7 * 60 * 60 * 1000));
            const year = gmt7Time.getFullYear();
            const month = String(gmt7Time.getMonth() + 1).padStart(2, '0');
            const day = String(gmt7Time.getDate()).padStart(2, '0');
            const hours = String(gmt7Time.getHours()).padStart(2, '0');
            const minutes = String(gmt7Time.getMinutes()).padStart(2, '0');
            const timestamp = `${year}-${month}-${day} ${hours}:${minutes}`;
            
            // Lấy Id từ server
            const serverId = item.serverId;
            
            if (!serverId) {
              console.error('[Form 3] ServerId not found:', item);
              showToast('Không tìm thấy Id từ server. Vui lòng tải lại dữ liệu.', 'error');
              modalF3DeclarationSubmit.disabled = false;
              modalF3DeclarationSubmit.textContent = 'Lưu thay đổi';
              return;
            }
            
            const payload = {
              action: 'update_subtask',
              Id: serverId, // Id từ server (số nguyên)
              timestamp: timestamp,
              level: 'subtask',
              epic_name: epic?.name || '',
              story_name: story?.name || '',
              subtask_name: item.name || '',
              status: status,
              jira_key: jiraKey,
              jira_link: jiraLink || '',
              note: note || '',
              assignee: item.assignee || '',
              start_date: item.startDate || '',
              due_date: item.dueDate || '',
              completed_date: item.completedDate || ''
            };
            
            console.log('[Form 3] Sending payload:', payload);
            
            await updateF3Subtask(F3_CURRENT_SUBTASK_ID, payload);

            // Cập nhật dữ liệu local ngay lập tức trong F3_ALL_DATA
            const updatedResult = findF3ItemById(F3_CURRENT_SUBTASK_ID);
            if (updatedResult && updatedResult.item) {
              // Lưu giá trị cũ để debug
              const oldJiraKey = updatedResult.item.jiraKey;
              
              // Cập nhật trực tiếp vào object trong F3_ALL_DATA
              updatedResult.item.status = status;
              updatedResult.item.jiraKey = jiraKey || '';
              updatedResult.item.jiraLink = jiraLink || '';
              updatedResult.item.note = note || '';
              
              console.log('[Form 3] Cập nhật dữ liệu local:');
              console.log('  - Subtask ID:', F3_CURRENT_SUBTASK_ID);
              console.log('  - jiraKey cũ:', oldJiraKey);
              console.log('  - jiraKey mới:', updatedResult.item.jiraKey);
              console.log('  - status:', updatedResult.item.status);
              console.log('  - Item object:', updatedResult.item);
              
              // Áp dụng lại filter để tạo lại F3_FILTERED_DATA từ F3_ALL_DATA đã cập nhật
              // Hàm filterF3Data() sẽ tự động gọi renderF3Table() ở cuối
              filterF3Data();
            } else {
              console.error('[Form 3] Không tìm thấy item để cập nhật:', F3_CURRENT_SUBTASK_ID);
              console.error('[Form 3] F3_ALL_DATA:', F3_ALL_DATA);
              // Nếu không tìm thấy, vẫn render lại để đảm bảo UI được cập nhật
              renderF3Table();
            }

            showToast('Cập nhật thông tin thành công', 'success');
            
            // Đóng modal
            closeF3DeclarationModal();

            // Tải lại dữ liệu từ server để đồng bộ (chạy ngầm)
            loadF3Data().catch(err => {
              console.error('Lỗi khi tải lại dữ liệu:', err);
            });
          } catch (error) {
            console.error('[Form 3] Error updating subtask:', error);
            showToast('Lỗi khi cập nhật: ' + error.message, 'error');
          } finally {
            modalF3DeclarationSubmit.disabled = false;
            modalF3DeclarationSubmit.textContent = 'Lưu thay đổi';
          }
        });
      }

      // Modal overlay click để đóng modal
      if (modalF3DeclarationOverlay) {
        modalF3DeclarationOverlay.addEventListener('click', (e) => {
          e.preventDefault();
          closeF3DeclarationModal();
        });
      }

      // Click vào modal container để đóng
      if (modalF3Declaration) {
        modalF3Declaration.addEventListener('click', (e) => {
          if (e.target === modalF3Declaration) {
            closeF3DeclarationModal();
          }
        });
      }

      // Modal Add Story
      const modalF3AddStory = document.getElementById('modal-f3-add-story');
      const modalF3AddStoryClose = document.getElementById('modal-f3-add-story-close');
      const modalF3AddStoryCancel = document.getElementById('modal-f3-add-story-cancel');
      const modalF3AddStorySubmit = document.getElementById('modal-f3-add-story-submit');
      const modalF3AddStoryOverlay = document.getElementById('modal-f3-add-story-overlay');
      const modalF3AddStoryContent = document.getElementById('modal-f3-add-story-content');
      
      const closeModalF3AddStory = () => {
        const modal = document.getElementById('modal-f3-add-story');
        if (modal) {
          modal.classList.add('hidden');
          modal.style.display = 'none';
        }
      };

      if (modalF3AddStoryContent) {
        modalF3AddStoryContent.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }

      if (modalF3AddStoryClose) {
        modalF3AddStoryClose.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeModalF3AddStory();
        });
      }

      if (modalF3AddStoryCancel) {
        modalF3AddStoryCancel.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeModalF3AddStory();
        });
      }

      if (modalF3AddStoryOverlay) {
        modalF3AddStoryOverlay.addEventListener('click', (e) => {
          e.preventDefault();
          closeModalF3AddStory();
        });
      }

      if (modalF3AddStory) {
        modalF3AddStory.addEventListener('click', (e) => {
          if (e.target === modalF3AddStory) {
            closeModalF3AddStory();
          }
        });
      }
      
      if (modalF3AddStorySubmit) {
        modalF3AddStorySubmit.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const form = document.getElementById('modal-f3-add-story-form');
          if (!form || !form.checkValidity()) {
            form?.reportValidity();
            return;
          }

          const epicId = document.getElementById('modal-f3-add-story-epic-id')?.value;
          const epicName = document.getElementById('modal-f3-add-story-epic-name')?.textContent || '';
          const storyName = document.getElementById('modal-f3-add-story-name')?.value;
          const storyCode = document.getElementById('modal-f3-add-story-code')?.value || '';
          const assignee = document.getElementById('modal-f3-add-story-assignee')?.value;
          const startDate = document.getElementById('modal-f3-add-story-start-date')?.value;
          const dueDate = document.getElementById('modal-f3-add-story-due-date')?.value;
          const jiraKey = document.getElementById('modal-f3-add-story-jira-key')?.value;
          const jiraLink = document.getElementById('modal-f3-add-story-jira-link')?.value || '';
          const note = document.getElementById('modal-f3-add-story-note')?.value || '';

          if (!storyName || !assignee || !startDate || !dueDate || !jiraKey) {
            showToast('Vui lòng điền đầy đủ thông tin bắt buộc', 'error');
            return;
          }

          try {
            modalF3AddStorySubmit.disabled = true;
            const originalText = modalF3AddStorySubmit.textContent;
            modalF3AddStorySubmit.textContent = 'Đang thêm...';

            await createF3Story({
              level: 'story',
              epic_id: epicId,
              epic_name: epicName,
              story_name: storyName,
              story_code: storyCode,
              assignee: assignee,
              start_date: startDate,
              due_date: dueDate,
              jira_key: jiraKey,
              jira_link: jiraLink,
              note: note,
              status: 'Đang triển khai'
            });

            showToast('Thêm Story thành công', 'success');
            
            // Đóng modal và reset form
            closeModalF3AddStory();
            if (form) form.reset();

            // Tải lại dữ liệu
            await loadF3Data();
          } catch (error) {
            console.error('[Form 3] Error creating story:', error);
            showToast('Lỗi khi thêm Story: ' + error.message, 'error');
          } finally {
            modalF3AddStorySubmit.disabled = false;
            modalF3AddStorySubmit.textContent = 'Thêm Story';
          }
        });
      }

      // Modal Add Subtask
      const modalF3AddSubtask = document.getElementById('modal-f3-add-subtask');
      const modalF3AddSubtaskClose = document.getElementById('modal-f3-add-subtask-close');
      const modalF3AddSubtaskCancel = document.getElementById('modal-f3-add-subtask-cancel');
      const modalF3AddSubtaskSubmit = document.getElementById('modal-f3-add-subtask-submit');
      const modalF3AddSubtaskOverlay = document.getElementById('modal-f3-add-subtask-overlay');
      const modalF3AddSubtaskContent = document.getElementById('modal-f3-add-subtask-content');
      
      const closeModalF3AddSubtask = () => {
        const modal = document.getElementById('modal-f3-add-subtask');
        if (modal) {
          modal.classList.add('hidden');
          modal.style.display = 'none';
        }
      };

      if (modalF3AddSubtaskContent) {
        modalF3AddSubtaskContent.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }

      if (modalF3AddSubtaskClose) {
        modalF3AddSubtaskClose.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeModalF3AddSubtask();
        });
      }

      if (modalF3AddSubtaskCancel) {
        modalF3AddSubtaskCancel.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeModalF3AddSubtask();
        });
      }

      if (modalF3AddSubtaskOverlay) {
        modalF3AddSubtaskOverlay.addEventListener('click', (e) => {
          e.preventDefault();
          closeModalF3AddSubtask();
        });
      }

      if (modalF3AddSubtask) {
        modalF3AddSubtask.addEventListener('click', (e) => {
          if (e.target === modalF3AddSubtask) {
            closeModalF3AddSubtask();
          }
        });
      }
      
      if (modalF3AddSubtaskSubmit) {
        modalF3AddSubtaskSubmit.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const form = document.getElementById('modal-f3-add-subtask-form');
          if (!form || !form.checkValidity()) {
            form?.reportValidity();
            return;
          }

          const epicId = document.getElementById('modal-f3-add-subtask-epic-id')?.value;
          const epicName = document.getElementById('modal-f3-add-subtask-epic-name')?.textContent || '';
          const storyId = document.getElementById('modal-f3-add-subtask-story-id')?.value;
          const storyName = document.getElementById('modal-f3-add-subtask-story-name')?.textContent || '';
          const subtaskName = document.getElementById('modal-f3-add-subtask-name')?.value;
          const taskCode = document.getElementById('modal-f3-add-subtask-task-code')?.value || '';
          const assignee = document.getElementById('modal-f3-add-subtask-assignee')?.value;
          const startDate = document.getElementById('modal-f3-add-subtask-start-date')?.value;
          const dueDate = document.getElementById('modal-f3-add-subtask-due-date')?.value;
          const jiraKey = document.getElementById('modal-f3-add-subtask-jira-key')?.value;
          const jiraLink = document.getElementById('modal-f3-add-subtask-jira-link')?.value || '';
          const note = document.getElementById('modal-f3-add-subtask-note')?.value || '';

          if (!subtaskName || !assignee || !startDate || !dueDate || !jiraKey) {
            showToast('Vui lòng điền đầy đủ thông tin bắt buộc', 'error');
            return;
          }

          try {
            modalF3AddSubtaskSubmit.disabled = true;
            const originalText = modalF3AddSubtaskSubmit.textContent;
            modalF3AddSubtaskSubmit.textContent = 'Đang thêm...';

            await createF3Subtask({
              level: 'subtask',
              epic_id: epicId,
              epic_name: epicName,
              story_id: storyId,
              story_name: storyName,
              subtask_name: subtaskName,
              task_code: taskCode,
              assignee: assignee,
              start_date: startDate,
              due_date: dueDate,
              jira_key: jiraKey,
              jira_link: jiraLink,
              note: note,
              status: 'Đang triển khai'
            });

            showToast('Thêm Sub-task thành công', 'success');
            
            // Đóng modal và reset form
            closeModalF3AddSubtask();
            if (form) form.reset();

            // Tải lại dữ liệu
            await loadF3Data();
          } catch (error) {
            console.error('[Form 3] Error creating subtask:', error);
            showToast('Lỗi khi thêm Sub-task: ' + error.message, 'error');
          } finally {
            modalF3AddSubtaskSubmit.disabled = false;
            modalF3AddSubtaskSubmit.textContent = 'Thêm Sub-task';
          }
        });
      }
    }

    // Gọi khởi tạo khi DOM sẵn sàng
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initF3EventListeners);
    } else {
      initF3EventListeners();
    }

    // ===== FORM 6 - DASHBOARD THỐNG KÊ =====
    let F6_CHARTS = {
      subtaskStatus: null,
      picDistribution: null
    };
    
    // Dữ liệu từ file JSON cho Form 6
    let F6_DATA = null;

    // Load dữ liệu từ file JSON (mở file picker)
    function loadF6DataFromFile() {
      const fileInput = document.getElementById('f6-file-input');
      if (fileInput) {
        fileInput.click();
      } else {
        showToast('Không tìm thấy file input', 'error');
      }
    }

    // Load dữ liệu từ file input
    function handleF6FileInput(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const jsonData = JSON.parse(text);
          
          // Chuyển đổi dữ liệu phẳng sang format phân cấp
          F6_DATA = organizeF3Data(jsonData);
          updateF6Dashboard();
          showToast('Đã tải dữ liệu thành công', 'success');
        } catch (error) {
          console.error('Lỗi khi parse JSON:', error);
          showToast('Lỗi định dạng file JSON', 'error');
        }
      };
      reader.readAsText(file);
    }

    // Lấy dữ liệu để sử dụng (ưu tiên F6_DATA, fallback về F3_ALL_DATA)
    function getF6Data() {
      return F6_DATA || F3_ALL_DATA;
    }

    // Tính toán thống kê từ dữ liệu
    function calculateF6Stats() {
      const data = getF6Data();
      if (!data || !data.epics || data.epics.length === 0) {
        return {
          totalEpics: 0,
          totalStories: 0,
          totalSubtasks: 0,
          completedSubtasks: 0,
          completionRate: 0
        };
      }

      let totalEpics = data.epics.length;
      let totalStories = 0;
      let totalSubtasks = 0;
      let completedSubtasks = 0;

      data.epics.forEach(epic => {
        if (epic.stories && epic.stories.length > 0) {
          totalStories += epic.stories.length;
          epic.stories.forEach(story => {
            if (story.subtasks && story.subtasks.length > 0) {
              story.subtasks.forEach(subtask => {
                const isCanceled = subtask.isCanceled === true || subtask.isCanceled === 'true';
                const status = (subtask.status || '').toLowerCase();
                
                // Không tính các subtask đã hủy vào tổng số
                if (!isCanceled && !status.includes('hủy') && !status.includes('cancel')) {
                  totalSubtasks++;
                  if (status.includes('hoàn thành') || status.includes('completed')) {
                    completedSubtasks++;
                  }
                }
              });
            }
          });
        }
      });

      const completionRate = totalSubtasks > 0 
        ? Math.round((completedSubtasks / totalSubtasks) * 100) 
        : 0;

      return {
        totalEpics,
        totalStories,
        totalSubtasks,
        completedSubtasks,
        completionRate
      };
    }

    // Cập nhật thống kê trên dashboard
    function updateF6Stats() {
      const stats = calculateF6Stats();
      
      const projectsEl = document.getElementById('f6-stat-projects');
      const tasksEl = document.getElementById('f6-stat-tasks');
      const subtasksEl = document.getElementById('f6-stat-subtasks');
      const completionEl = document.getElementById('f6-stat-completion');

      if (projectsEl) projectsEl.textContent = stats.totalEpics;
      if (tasksEl) tasksEl.textContent = stats.totalStories;
      if (subtasksEl) subtasksEl.textContent = stats.totalSubtasks;
      if (completionEl) completionEl.textContent = stats.completionRate + '%';
    }

    // Tính toán dữ liệu cho biểu đồ trạng thái subtask
    function getF6SubtaskStatusData() {
      const statusCount = {
        'Hoàn thành': 0,
        'Đang triển khai': 0,
        'Chưa triển khai': 0,
        'Đã hủy': 0
      };

      const data = getF6Data();
      if (data && data.epics) {
        data.epics.forEach(epic => {
          if (epic.stories) {
            epic.stories.forEach(story => {
              if (story.subtasks) {
                story.subtasks.forEach(subtask => {
                  const status = subtask.status || '';
                  const statusLower = status.toLowerCase();
                  const isCanceled = subtask.isCanceled === true || subtask.isCanceled === 'true';
                  
                  if (isCanceled || statusLower.includes('hủy') || statusLower.includes('cancel')) {
                    statusCount['Đã hủy']++;
                  } else if (statusLower.includes('hoàn thành') || statusLower.includes('completed')) {
                    statusCount['Hoàn thành']++;
                  } else if (statusLower.includes('đang triển khai') || statusLower.includes('in progress')) {
                    statusCount['Đang triển khai']++;
                  } else if (statusLower.includes('chưa triển khai') || statusLower.includes('not started')) {
                    statusCount['Chưa triển khai']++;
                  } else {
                    // Mặc định là chưa triển khai nếu không xác định được
                    statusCount['Chưa triển khai']++;
                  }
                });
              }
            });
          }
        });
      }

      return {
        labels: Object.keys(statusCount),
        data: Object.values(statusCount),
        colors: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444']
      };
    }

    // Tính toán dữ liệu cho biểu đồ phân bổ theo người thực hiện
    function getF6PicDistributionData() {
      const picCount = {};

      const data = getF6Data();
      if (data && data.epics) {
        data.epics.forEach(epic => {
          if (epic.assignee) {
            picCount[epic.assignee] = (picCount[epic.assignee] || 0) + 1;
          }
          if (epic.stories) {
            epic.stories.forEach(story => {
              if (story.assignee) {
                picCount[story.assignee] = (picCount[story.assignee] || 0) + 1;
              }
              if (story.subtasks) {
                story.subtasks.forEach(subtask => {
                  if (subtask.assignee) {
                    picCount[subtask.assignee] = (picCount[subtask.assignee] || 0) + 1;
                  }
                });
              }
            });
          }
        });
      }

      const sortedPics = Object.entries(picCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // Top 10

      return {
        labels: sortedPics.map(([name]) => name),
        data: sortedPics.map(([, count]) => count)
      };
    }

    // Render biểu đồ trạng thái subtask
    function renderF6SubtaskStatusChart() {
      const canvas = document.getElementById('f6-chart-subtask-status');
      if (!canvas) return;

      // Xóa chart cũ nếu có
      if (F6_CHARTS.subtaskStatus) {
        F6_CHARTS.subtaskStatus.destroy();
      }

      const chartData = getF6SubtaskStatusData();
      
      // Tạo canvas nếu chưa có
      let chartCanvas = canvas.querySelector('canvas');
      if (!chartCanvas) {
        chartCanvas = document.createElement('canvas');
        canvas.innerHTML = '';
        canvas.appendChild(chartCanvas);
      }

      F6_CHARTS.subtaskStatus = new Chart(chartCanvas, {
        type: 'doughnut',
        data: {
          labels: chartData.labels,
          datasets: [{
            data: chartData.data,
            backgroundColor: chartData.colors,
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Render biểu đồ phân bổ theo PIC
    function renderF6PicDistributionChart() {
      const canvas = document.getElementById('f6-chart-pic-distribution');
      if (!canvas) return;

      // Xóa chart cũ nếu có
      if (F6_CHARTS.picDistribution) {
        F6_CHARTS.picDistribution.destroy();
      }

      const chartData = getF6PicDistributionData();
      
      // Tạo canvas nếu chưa có
      let chartCanvas = canvas.querySelector('canvas');
      if (!chartCanvas) {
        chartCanvas = document.createElement('canvas');
        canvas.innerHTML = '';
        canvas.appendChild(chartCanvas);
      }

      F6_CHARTS.picDistribution = new Chart(chartCanvas, {
        type: 'bar',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: 'Số lượng công việc',
            data: chartData.data,
            backgroundColor: '#3b82f6',
            borderColor: '#2563eb',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    // Lấy danh sách subtask sắp hết hạn (7 ngày tới)
    function getF6DueTasks() {
      const dueTasks = [];
      const today = new Date();
      const sevenDaysLater = new Date(today);
      sevenDaysLater.setDate(today.getDate() + 7);

      const data = getF6Data();
      if (data && data.epics) {
        data.epics.forEach(epic => {
          if (epic.stories) {
            epic.stories.forEach(story => {
              if (story.subtasks) {
                story.subtasks.forEach(subtask => {
                  const isCanceled = subtask.isCanceled === true || subtask.isCanceled === 'true';
                  const status = (subtask.status || '').toLowerCase();
                  
                  // Bỏ qua các subtask đã hủy
                  if (!isCanceled && !status.includes('hủy') && !status.includes('cancel')) {
                    if (subtask.dueDate) {
                      const dueDate = new Date(subtask.dueDate);
                      if (dueDate >= today && dueDate <= sevenDaysLater) {
                        const daysLeft = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                        dueTasks.push({
                          name: subtask.name,
                          epic: epic.name,
                          assignee: subtask.assignee || '-',
                          dueDate: subtask.dueDate,
                          daysLeft: daysLeft
                        });
                      }
                    }
                  }
                });
              }
            });
          }
        });
      }

      return dueTasks.sort((a, b) => {
        const dateA = new Date(a.dueDate);
        const dateB = new Date(b.dueDate);
        return dateA - dateB;
      });
    }

    // Render bảng subtask sắp hết hạn
    function renderF6DueTasks() {
      const tbody = document.getElementById('f6-due-tasks-body');
      if (!tbody) return;

      const dueTasks = getF6DueTasks();

      if (dueTasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Không có tác vụ nào sắp hết hạn</td></tr>';
        return;
      }

      tbody.innerHTML = dueTasks.map(task => `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 text-gray-900">${escapeHtml(task.name)}</td>
          <td class="px-6 py-4 text-gray-600">${escapeHtml(task.epic)}</td>
          <td class="px-6 py-4 text-gray-600">${escapeHtml(task.assignee)}</td>
          <td class="px-6 py-4 text-gray-600">${formatF3Date(task.dueDate)}</td>
          <td class="px-6 py-4">
            <span class="px-2 py-1 text-xs font-medium rounded ${task.daysLeft <= 3 ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">
              ${task.daysLeft} ngày
            </span>
          </td>
        </tr>
      `).join('');
    }

    // Render bảng chi tiết dự án
    function renderF6ProjectsTable() {
      const tbody = document.getElementById('f6-projects-table-body');
      if (!tbody) return;

      const data = getF6Data();
      if (!data || !data.epics || data.epics.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Chưa có dữ liệu</td></tr>';
        return;
      }

      tbody.innerHTML = data.epics.map(epic => {
        let totalStories = 0;
        let totalSubtasks = 0;
        let completedSubtasks = 0;

        if (epic.stories) {
          totalStories = epic.stories.length;
          epic.stories.forEach(story => {
            if (story.subtasks) {
              story.subtasks.forEach(subtask => {
                const isCanceled = subtask.isCanceled === true || subtask.isCanceled === 'true';
                const status = (subtask.status || '').toLowerCase();
                
                // Không tính các subtask đã hủy vào tổng số
                if (!isCanceled && !status.includes('hủy') && !status.includes('cancel')) {
                  totalSubtasks++;
                  if (status.includes('hoàn thành') || status.includes('completed')) {
                    completedSubtasks++;
                  }
                }
              });
            }
          });
        }

        const progress = totalSubtasks > 0 
          ? Math.round((completedSubtasks / totalSubtasks) * 100) 
          : 0;

        return `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 text-gray-900 font-medium">${escapeHtml(epic.jiraKey || '-')}</td>
            <td class="px-6 py-4 text-gray-900">${escapeHtml(epic.name || '-')}</td>
            <td class="px-6 py-4 text-gray-600">${totalStories}</td>
            <td class="px-6 py-4 text-gray-600">${totalSubtasks}</td>
            <td class="px-6 py-4">
              <div class="flex items-center gap-2">
                <div class="flex-1 bg-gray-200 rounded-full h-2">
                  <div class="bg-blue-600 h-2 rounded-full" style="width: ${progress}%"></div>
                </div>
                <span class="text-sm text-gray-600">${progress}%</span>
              </div>
            </td>
            <td class="px-6 py-4 text-gray-600">${escapeHtml(epic.assignee || '-')}</td>
          </tr>
        `;
      }).join('');
    }

    // Cập nhật toàn bộ dashboard Form 6
    function updateF6Dashboard() {
      updateF6Stats();
      renderF6SubtaskStatusChart();
      renderF6PicDistributionChart();
      renderF6DueTasks();
      renderF6ProjectsTable();
    }

    // Tải lại dữ liệu Form 6
    function refreshF6Data() {
      const data = getF6Data();
      if (!data || !data.epics || data.epics.length === 0) {
        showToast('Vui lòng tải dữ liệu trước', 'info');
        return;
      }
      updateF6Dashboard();
      showToast('Đã cập nhật dashboard', 'success');
    }

    // Form 6 Event Listeners
    function initF6EventListeners() {
      const f6RefreshBtn = document.getElementById('f6-refresh-btn');
      const f6LoadBtn = document.getElementById('f6-load-btn');
      const f6FileInput = document.getElementById('f6-file-input');
      const f6SearchInput = document.getElementById('f6-search-input');

      if (f6RefreshBtn) {
        f6RefreshBtn.addEventListener('click', refreshF6Data);
      }

      if (f6LoadBtn) {
        f6LoadBtn.addEventListener('click', loadF6DataFromFile);
      }

      if (f6FileInput) {
        f6FileInput.addEventListener('change', handleF6FileInput);
      }

      if (f6SearchInput) {
        f6SearchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const rows = document.querySelectorAll('#f6-projects-table-body tr');
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
          });
        });
      }
    }

    // Gọi khởi tạo Form 6 khi DOM sẵn sàng
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initF6EventListeners);
    } else {
      initF6EventListeners();
    }


    // ===== FORM 4, 5, 7 - Placeholder JavaScript =====
    // TODO: Copy đầy đủ JavaScript từ file nguồn cho các form này
    // Hiện tại chỉ có HTML structure, cần thêm JavaScript để các form hoạt động

  </script>

  <!-- MODAL SYSTEM - FORM 3: DECLARATION (Khai báo thay đổi) -->
  <!-- ============================================ -->
  <div id="modal-f3-declaration" class="modal-container modal-f3-declaration fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f3-declaration-overlay" class="modal-overlay modal-f3-declaration-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f3-declaration-content" class="modal-content modal-f3-declaration-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Cập nhật thông tin</h2>
            <p class="text-sm text-gray-600">Cập nhật trạng thái, Jira Key và Note cho tác vụ</p>
          </div>
          <button type="button" id="modal-f3-declaration-close" class="modal-close modal-f3-declaration-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-icons">close</span>
          </button>
        </div>
        
        <!-- Modal Body -->
        <div id="modal-f3-declaration-body" class="modal-body modal-f3-declaration-body overflow-y-auto flex-1 p-4 space-y-6">
          <!-- Thông tin tác vụ -->
          <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
            <h4 class="text-lg font-semibold text-gray-700 mb-3">Thông tin tác vụ</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Epic</label>
                <input type="text" id="modal-f3-declaration-epic" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" readonly/>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Story</label>
                <input type="text" id="modal-f3-declaration-story" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" readonly/>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Subtask</label>
                <input type="text" id="modal-f3-declaration-subtask" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500" readonly/>
              </div>
            </div>
          </div>

          <!-- Cập nhật thông tin -->
          <div class="border border-gray-200 rounded-lg p-4 bg-blue-50">
            <h4 class="text-lg font-semibold text-gray-700 mb-3">Cập nhật thông tin</h4>
            
            <!-- Trạng thái -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái *</label>
              <select id="modal-f3-declaration-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <option value="">Chọn trạng thái</option>
                <option value="Hoàn thành">Hoàn thành</option>
                <option value="Đang triển khai">Đang triển khai</option>
                <option value="Chưa triển khai">Chưa triển khai</option>
                <option value="Hủy tác vụ">Hủy tác vụ</option>
              </select>
            </div>

            <!-- Mã Jira -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Mã Jira *</label>
              <input type="text" id="modal-f3-declaration-jira-key" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập Mã Jira..."/>
            </div>

            <!-- Link jira -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">Link jira</label>
              <input type="text" id="modal-f3-declaration-jira-link" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập link jira..."/>
            </div>

            <!-- Link - Đã ẩn theo yêu cầu -->
            <div class="mb-4 hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2">Link</label>
              <input type="text" id="modal-f3-declaration-link" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập link..."/>
            </div>

            <!-- Note -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Note</label>
              <textarea id="modal-f3-declaration-note" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập ghi chú..."></textarea>
            </div>
          </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="mt-6 flex justify-end gap-3 border-t border-gray-200 pt-4">
          <button type="button" id="modal-f3-declaration-cancel" class="modal-cancel-btn modal-f3-declaration-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
          <button type="button" id="modal-f3-declaration-submit" class="modal-submit-btn modal-f3-declaration-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">Lưu thay đổi</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 3: DECLARATION -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 3: ADD STORY (Thêm Story) -->
  <!-- ============================================ -->
  <div id="modal-f3-add-story" class="modal-container modal-f3-add-story fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f3-add-story-overlay" class="modal-overlay modal-f3-add-story-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f3-add-story-content" class="modal-content modal-f3-add-story-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Thêm Story mới</h2>
            <p class="text-sm text-gray-600">Thêm Story vào Epic: <span id="modal-f3-add-story-epic-name" class="font-medium text-blue-600"></span></p>
          </div>
          <button id="modal-f3-add-story-close" class="modal-close modal-f3-add-story-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-icons">close</span>
          </button>
        </div>
        
        <form id="modal-f3-add-story-form" class="modal-body overflow-y-auto flex-1 space-y-6">
          <input type="hidden" id="modal-f3-add-story-epic-id" />
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Tên Story *</label>
              <input type="text" id="modal-f3-add-story-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập tên Story..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Story Code *</label>
              <input type="text" id="modal-f3-add-story-code" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tự động sinh..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Người thực hiện *</label>
              <select id="modal-f3-add-story-assignee" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Chọn người thực hiện</option>
                <option>Trần Văn Hoàng</option>
                <option>Nguyễn Kim Cương</option>
                <option>Trịnh Xuân Hạnh</option>
                <option>Đỗ Xuân Huy</option>
                <option>Giang Văn Toàn</option>
                <option>Vũ Ngọc Diệp</option>
                <option>Bùi Ngọc Hùng</option>
                <option>Nguyễn Thế Việt</option>
                <option>Nguyễn Mạnh Quang</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ngày bắt đầu *</label>
              <input type="date" id="modal-f3-add-story-start-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Hạn hoàn thành *</label>
              <input type="date" id="modal-f3-add-story-due-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Mã Jira *</label>
              <input type="text" id="modal-f3-add-story-jira-key" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập Mã Jira..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Link jira</label>
              <input type="text" id="modal-f3-add-story-jira-link" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập link jira..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái *</label>
              <select id="modal-f3-add-story-status" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-not-allowed">
                <option value="Đang triển khai" selected>Đang triển khai</option>
              </select>
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Note</label>
              <textarea id="modal-f3-add-story-note" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập ghi chú..."></textarea>
            </div>
          </div>
        </form>
        
        <div class="mt-6 flex justify-end gap-3 border-t border-gray-200 pt-4">
          <button type="button" id="modal-f3-add-story-cancel" class="modal-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
          <button type="submit" id="modal-f3-add-story-submit" class="modal-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">Thêm Story</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 3: ADD STORY -->
  <!-- ============================================ -->

  <!-- ============================================ -->
  <!-- MODAL SYSTEM - FORM 3: ADD SUBTASK (Thêm Sub-task) -->
  <!-- ============================================ -->
  <div id="modal-f3-add-subtask" class="modal-container modal-f3-add-subtask fixed inset-0 z-50 hidden" style="display: none;">
    <div id="modal-f3-add-subtask-overlay" class="modal-overlay modal-f3-add-subtask-overlay fixed inset-0 bg-black/30 backdrop-blur-sm z-40"></div>
    <div id="modal-f3-add-subtask-content" class="modal-content modal-f3-add-subtask-content fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
      <div class="w-full max-w-3xl rounded-xl bg-white p-8 shadow-xl pointer-events-auto relative z-50 max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-start justify-between mb-6">
          <div class="flex flex-col gap-1">
            <h2 class="text-2xl font-bold text-gray-900">Thêm Sub-task mới</h2>
            <p class="text-sm text-gray-600">Thêm Sub-task vào Story: <span id="modal-f3-add-subtask-story-name" class="font-medium text-blue-600"></span></p>
            <p class="text-xs text-gray-500">Epic: <span id="modal-f3-add-subtask-epic-name" class="font-medium"></span></p>
          </div>
          <button id="modal-f3-add-subtask-close" class="modal-close modal-f3-add-subtask-close text-gray-500 hover:text-gray-700 transition">
            <span class="material-icons">close</span>
          </button>
        </div>
        
        <form id="modal-f3-add-subtask-form" class="modal-body overflow-y-auto flex-1 space-y-6">
          <input type="hidden" id="modal-f3-add-subtask-epic-id" />
          <input type="hidden" id="modal-f3-add-subtask-story-id" />
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Tên Sub-task *</label>
              <input type="text" id="modal-f3-add-subtask-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập tên Sub-task..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Task Code *</label>
              <input type="text" id="modal-f3-add-subtask-task-code" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Tự động sinh..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Người thực hiện *</label>
              <select id="modal-f3-add-subtask-assignee" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Chọn người thực hiện</option>
                <option>Trần Văn Hoàng</option>
                <option>Nguyễn Thế Việt</option>
                <option>Nguyễn Mạnh Quang</option>
                <option>Nguyễn Kim Cương</option>
                <option>Trịnh Xuân Hạnh</option>
                <option>Đỗ Xuân Huy</option>
                <option>Giang Văn Toàn</option>
                <option>Vũ Ngọc Diệp</option>
                <option>Bùi Ngọc Hùng</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái *</label>
              <select id="modal-f3-add-subtask-status" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-not-allowed">
                <option value="Chưa triển khai" selected>Chưa triển khai</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Ngày bắt đầu *</label>
              <input type="date" id="modal-f3-add-subtask-start-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Hạn hoàn thành *</label>
              <input type="date" id="modal-f3-add-subtask-due-date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Mã Jira *</label>
              <input type="text" id="modal-f3-add-subtask-jira-key" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập Mã Jira..."/>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Link jira</label>
              <input type="text" id="modal-f3-add-subtask-jira-link" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập link jira..."/>
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">Note</label>
              <textarea id="modal-f3-add-subtask-note" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập ghi chú..."></textarea>
            </div>
          </div>
        </form>
        
        <div class="mt-6 flex justify-end gap-3 border-t border-gray-200 pt-4">
          <button type="button" id="modal-f3-add-subtask-cancel" class="modal-cancel-btn h-11 rounded-full border border-gray-300 bg-white px-6 text-sm font-bold text-gray-700 shadow-sm hover:bg-gray-50">Hủy</button>
          <button type="submit" id="modal-f3-add-subtask-submit" class="modal-submit-btn h-11 rounded-full bg-primary-blue px-6 text-sm font-bold text-white shadow-sm hover:shadow-md">Thêm Sub-task</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ============================================ -->
  <!-- END MODAL SYSTEM - FORM 3: ADD SUBTASK -->
  <!-- ============================================ -->

</body>
</html>








